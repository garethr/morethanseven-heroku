<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <title>Self Contained Jruby Web Applications</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
    <meta content='deployment, jruby, warbler, jetty' name='keywords' />
    <meta content='etkmKMftqAyYJM6-DP_TTKJjV0EHM5vbVcaOloSo8Z8' name='google-site-verification' />
    <link href='/assets/css/reset.css' rel='stylesheet' type='text/css' />
    <link href='/assets/css/style.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/css/code.css' rel='stylesheet' type='text/css' />
    <link href='http://www.myopenid.com/server' rel='openid.server' />
    <link href='http://garethr.myopenid.com/' rel='openid.delegate' />
    <link href='/articles.atom' rel='alternate' title='Morethanseven Atom Feed' type='application/atom+xml' />
  </head>
  <body>
    <div id='main'>
      <div id='header'>
        <div class='logo'>
          <a href='/'>&laquo; morethanseven</a>
        </div>
        <div id='carbonads-container'>
          <div class='carbonad'>
            <div id='carbon'></div>
            <script type='text/javascript'>
              //<![CDATA[
                var z = document.createElement("script");
                z.type = "text/javascript";
                z.async = true;
                z.src = "http://engine.carbonads.com/z/12119/carbon_2_1_0_HORIZ";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(z, s);
              //]]>
            </script>
          </div>
        </div>
        <div id='nav'>
          <ul>
            <li><a href='/about.html'>about</a></li>
            <li><a href='/archives.html'>archives</a></li>
            <li><a href='/tags.html'>tags</a></li>
            <li>
              <a href='/articles.atom'>rss</a>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='article'>
        <h1>
          Self Contained Jruby Web Applications
        </h1>
        <div class='meta'>
          <ul class='tags'>
            <li>Apr 06, 2012</li>
            <li>
              &middot;
            </li>
            <li>
              <a href='/2012/04/06/Self-contained-jruby-web-applications.html#disqus_thread'></a>
            </li>
            <li>&middot;</li>
            <li>
              <a class='tag' href='/tags/deployment/'>
                deployment
              </a>
            </li>
            <li>
              <a class='tag' href='/tags/jetty/'>
                jetty
              </a>
            </li>
            <li>
              <a class='tag' href='/tags/jruby/'>
                jruby
              </a>
            </li>
            <li>
              <a class='tag' href='/tags/warbler/'>
                warbler
              </a>
            </li>
          </ul>
        </div>
        <div class='body'>
          <p>Several things seemed to come together at once to make me want to hack on this particular project. In no particular order:</p>
          <p>The <a href="http://www.thoughtworks.com/articles/technology-radar-march-2012">Thoughtworks Technology Radar</a> said the following:</p>
          <blockquote>
          <p>Embedding a servlet container, such as Jetty, inside a Java application has many advantages over running the application inside a container. Testing is relatively painless because of the simple startup, and the development environment is closer to production. Nasty surprises like mismatched versions of libraries or drivers are eliminated by not sharing across multiple applications. While you will have to manage and monitor multiple Java Virtual Machines in production using this model, we feel the advantages offered by the simplicity and isolation are significant.</p>
          </blockquote>
          <p>I&#8217;ve been getting more interested in JRuby anyway, partly because we&#8217;re finding ourselves using both Ruby and Scala at work, and maintaining a single target platform makes sense to me. Throw in the potential for interop between those languages and it&#8217;s certainly worth investigating.</p>
          <p><a href="http://www.playframework.org/">Play 2.0</a> shipped and currently only provides the ability to create a self contained executable with bundled web server. Creating <span class="caps">WAR</span> files for more traditional application servers is on the roadmap but interestingly wasn&#8217;t deemed essential for the big 2.0 release. I had a nice chat with <a href="https://twitter.com/minglis">Martyn Inglis</a> at work about some of the nice side effects of this setup.</p>
          <p>And throw in every time I have to configure straight Ruby applications for production environments I get cross. I know where all the bits and pieces are buried and can do it well, but with so many moving parts it&#8217;s absolutely no fun whatsoever.</p>
          <p>Warbler, the JRuby tool for creating <span class="caps">WAR</span> files from Ruby source, has just added the ability to <a href="https://github.com/jruby/warbler/commit/0558a285eb59a0801cf7c0f274777b06b63883b3">embed Jetty to the master branch</a>.</p>
          <p>I decided to take all of this for a quick spin, and the <a href="https://github.com/garethr/jruby-embedded-jetty">resulting code is up on GitHub</a>.</p>
          <p>This is the simplest Rack application possible, it just prints <em>Hello Jetty</em>. And the <span class="caps">README</span> covers how to install and run it so I won&#8217;t duplcate that information here.</p>
          <p>But I will print some nearly meaningless and unscientific benchmarks because, hey, who doesn&#8217;t like those?</p>
          <pre>âš¡ ab -c 50 -n 5000 http://localhost:8090/&#x000A;&#x000A;Server Software:        Jetty(8.y.z-SNAPSHOT)&#x000A;Server Hostname:        localhost&#x000A;Server Port:            8090&#x000A;&#x000A;Document Path:          /&#x000A;Document Length:        16 bytes&#x000A;&#x000A;Concurrency Level:      50&#x000A;Time taken for tests:   1.827 seconds&#x000A;Complete requests:      5000&#x000A;Failed requests:        0&#x000A;Write errors:           0&#x000A;Total transferred:      555999 bytes&#x000A;HTML transferred:       80144 bytes&#x000A;Requests per second:    2736.47 [#/sec] (mean)&#x000A;Time per request:       18.272 [ms] (mean)&#x000A;Time per request:       0.365 [ms] (mean, across all concurrent requests)&#x000A;Transfer rate:          297.16 [Kbytes/sec] received&#x000A;&#x000A;Connection Times (ms)&#x000A;              min  mean[+/-sd] median   max&#x000A;Connect:        0    2   2.2      1      18&#x000A;Processing:     1   16   7.7     15      61&#x000A;Waiting:        0   14   7.2     13      57&#x000A;Total:          2   18   7.5     17      61&#x000A;&#x000A;Percentage of the requests served within a certain time (ms)&#x000A;  50%     17&#x000A;  66%     19&#x000A;  75%     21&#x000A;  80%     22&#x000A;  90%     27&#x000A;  95%     30&#x000A;  98%     42&#x000A;  99%     52&#x000A; 100%     61 (longest request)</pre>
          <p>Running the same test on the same machine but using Ruby 1.9.2-p290 and Thin gives.</p>
          <pre>Server Software:        thin&#x000A;Server Hostname:        localhost&#x000A;Server Port:            9292&#x000A;&#x000A;Document Path:          /&#x000A;Document Length:        16 bytes&#x000A;&#x000A;Concurrency Level:      50&#x000A;Time taken for tests:   3.125 seconds&#x000A;Complete requests:      5000&#x000A;Failed requests:        0&#x000A;Write errors:           0&#x000A;Total transferred:      620620 bytes&#x000A;HTML transferred:       80080 bytes&#x000A;Requests per second:    1600.16 [#/sec] (mean)&#x000A;Time per request:       31.247 [ms] (mean)&#x000A;Time per request:       0.625 [ms] (mean, across all concurrent requests)&#x000A;Transfer rate:          193.96 [Kbytes/sec] received&#x000A;&#x000A;Connection Times (ms)&#x000A;              min  mean[+/-sd] median   max&#x000A;Connect:        0    0   0.3      0       9&#x000A;Processing:     3   31   6.4     33      52&#x000A;Waiting:        3   25   6.4     28      47&#x000A;Total:          4   31   6.4     33      52&#x000A;&#x000A;Percentage of the requests served within a certain time (ms)&#x000A;  50%     33&#x000A;  66%     34&#x000A;  75%     34&#x000A;  80%     35&#x000A;  90%     38&#x000A;  95%     41&#x000A;  98%     46&#x000A;  99%     50&#x000A; 100%     52 (longest request)</pre>
          <p>2736 requests per second on JRuby/Jetty vs 1600 on Ruby/Thin. As noted this isn&#8217;t meaningfully useful, in that it&#8217;s a hello world example and I&#8217;ve not tried to pick the fastest stacks on either side. I&#8217;m more bothered about it not being slower, because the main reason to pursue this approach is simplicity. Having a single self contained artefact that contains all it&#8217;s dependencies including a production web server is very appealing.</p>
          <p>I&#8217;m hoping to give this a go with some less trivial applications, and probably more importantly look to compare a production stack based around these self-contained executables vs the dependency chain that is modern Ruby application stacks.</p>
          <p>Thanks to <a href="http://blog.nicksieger.com/">Nick Sieger</a> for both writing Warbler and for helping with a few questions on the JRuby mailing list and on Twitter. Thanks also to <a href="https://twitter.com/jabley">James Abley</a> for a few pointers on Java system properties.</p>
        </div>
      </div>
      <div id='other-articles'>
        <div class='older'>
          <ul>
            <li>
              <h3>
                <a href='/2012/03/31/Recent-projects-and-talks.html' title=''>
                  &laquo; Recent Projects And Talks
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2012/02/19/Dashboards-at-govuk.html' title=''>
                  &laquo; Dashboards At Gov.Uk
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2012/01/06/Talking-to-jenkins-from-campfire-with-hubot.html' title=''>
                  &laquo; Talking To Jenkins From Campfire With Hubot
                </a>
              </h3>
            </li>
          </ul>
        </div>
        <div class='newer'>
          <ul>
            <li>
              <h3>
                <a href='/2012/06/05/Static-sites-with-nginx-on-heroku.html' title=''>
                  Static Sites With Nginx On Heroku &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2012/07/01/The-vagrantbox.es-story.html' title=''>
                  The Vagrantbox.es Story &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2012/08/11/Riemann-puppet-module.html' title=''>
                  Riemann Puppet Module &raquo;
                </a>
              </h3>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='comments'>
        <div id='disqus_thread'></div>
        <script src='http://disqus.com/forums/morethanseven/embed.js' type='text/javascript'></script>
        <noscript>
          <a href='http://disqus.com/forums/morethanseven/?url=ref'>
            View the discussion thread
          </a>
        </noscript>
      </div>
      <!-- / disqus adds too much visual crap -->
      <style type='text/css'>
        .dsq-dc-logo {
          display: none !important; }
      </style>
      <div class='clear'></div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        (function() {
          var links = document.getElementsByTagName('a');
          var query = '?';
          for(var i = 0; i < links.length; i++) {
            if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
            }
          }
          document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/morethanseven/get_num_replies.js' + query + '"></' + 'script>');
        })();
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        try {
          var pageTracker = _gat._getTracker("UA-435455-1");
          pageTracker._setDomainName(".morethanseven.net");
          pageTracker._setAllowHash(false);
          pageTracker._trackPageview();
          pageTracker._trackPageLoadTime();
        } catch(err) {}
      //]]>
    </script>
  </body>
</html>
