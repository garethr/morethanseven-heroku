
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Morethanseven</title>
  <meta name="author" content="Gareth Rushgrove">

  
  <meta name="description" content="I don&#8217;t appear to have been in a writing mood recently but I&#8217;ve been getting back into hacking on a couple of pet projects. The first &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.morethanseven.net/page/3">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/articles.atom" rel="alternate" title="Morethanseven" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<meta content="etkmKMftqAyYJM6-DP_TTKJjV0EHM5vbVcaOloSo8Z8" name="google-site-verification">
<link href="http://www.myopenid.com/server" rel="openid.server">
<link href="http://garethr.myopenid.com/" rel="openid.delegate">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-435455-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header>
<hgroup>
<h1><a href="/">Morethanseven</a></h1>
<p>The blog of Gareth Rushgrove</p>

<div id='carbonads-container'>
  <div class='carbonad'>
    <div id='carbon'></div>
    <script type='text/javascript'>
      //<![CDATA[
        var z = document.createElement("script");
        z.type = "text/javascript";
        z.async = true;
        z.src = "http://engine.carbonads.com/z/12119/carbon_2_1_0_HORIZ";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(z, s);
      //]]>
    </script>
  </div>
</div>

</hgroup>
</header>


  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/02/Exposing-puppet-and-facter-information-on-the-web/">Exposing Puppet and Facter Information on the Web</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-02T00:00:00+00:00" pubdate data-updated="true">Nov 2<span>nd</span>, 2011</time>
        
         | <a href="/2011/11/02/Exposing-puppet-and-facter-information-on-the-web/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I don&#8217;t appear to have been in a writing mood recently but I&#8217;ve been getting back into hacking on a couple of pet projects. The first fruits of this coding (mainly backwards and forwards on the train) I&#8217;ve just made available to anyone interested.</p>
<p><a href="https://github.com/garethr/web-puppet">Web Facter</a> is a gem which takes the output from <a href="https://github.com/puppetlabs/facter">Facter</a> and exposes this as <span class="caps">JSON</span> over <span class="caps">HTTP</span>. In theory you could run this on a configurable port on each of your machines and have a <span class="caps">URL</span> you can hit to get information on uptime, networking setup, hostnames or anything else exposed by Facter. It comes with a simple built-in web server and optional http basic authentication if you&#8217;re not going to do this via a proxy. The <span class="caps">JSON</span> display should be both human and machine readable, and I have a few ideas for projects which needed this information.</p>
<p>The other project is very similar, and even has a similar name, <a href="https://github.com/garethr/web-facter">Web Puppet</a>. You can run this on your puppet master and it exposes the node information (currently including the facts and tags) again as <span class="caps">JSON</span> over <span class="caps">HTTP</span>. I&#8217;m still working on this to make it a little more usable. At the moment it just shows you all nodes and all information, if you&#8217;re working with a larger cluster this isn&#8217;t really sensible. Recent versions of Puppet do have an <a href="http://docs.puppetlabs.com/guides/rest_api.html"><span class="caps">HTTP</span> based <span class="caps">API</span></a> but it requires some hoops to be jumped through and I&#8217;m not quite sure from the docs it lets me do what I want (I have a specific usecase, of which more soon all being well).</p>
<p>Both projects have had me reading the source code of Puppet and Facter, which for the most part has been enjoyable and informative. Puppet in particular has some great comments lying around :) Both of the above projects are available as gems for anyone else to play around with and build on, but my main aim is a little more high level. All being well I&#8217;ll have a couple of projects built atop these APIs shortly.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/10/Javascript-in-your-ruby-mongoid-map-reduce/">Javascript in Your Ruby: Mongoid Map Reduce</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-10T00:00:00+01:00" pubdate data-updated="true">Oct 10<span>th</span>, 2011</time>
        
         | <a href="/2011/10/10/Javascript-in-your-ruby-mongoid-map-reduce/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We&#8217;re pretty fond of <a href="http://mongodb.org/">Mongodb</a> at work and I&#8217;ve been getting an opportunity to kick some of the more interesting tyres recently. I thought I&#8217;d document something I found myself doing here, half hoping it might be useful for anyone else with a similar problem and also to see if anyone else has a much neater approach. The examples are obviously pretty trivial, but hopefully you get the idea.</p>
<p>So, we&#8217;re making using of the rather nice <a href="http://mongoid.org/">Mongoid</a> Ruby library for defining our models as Ruby classes. Here&#8217;s a couple of very simple classes. Anyone familiar with DataMapper or Django&#8217;s <span class="caps">ORM</span> should be right at home here.</p>
<pre>class Publication
  include Mongoid::Document

  field :name,            :type =&gt; String
  field :section,         :type =&gt; String
  field :body,            :type =&gt; String
  field :is_published,    :type =&gt; Boolean
end

class LongerPublication &lt; Publication
  field :extra_body,      :type =&gt; String
end
</pre>
<p>So we now have a good few publications and longer publications in our system. And folks have been creating sections with wild amandon. What I&#8217;d like to do now is do some reporting, specifically I want to know the numbers of Publications by type and publication status. And lets allow a breakdown by section while we&#8217;re at it.</p>
<p>One approach to this is using Mongo&#8217;s built in map-reduce capability. Mongoid exposes this pretty cleanly in my view, by allowing you to write the required javascript functions (a mapper and a reducer) inline in the Ruby code. This might feel evil, but seems the best of the available options. I can see for much larger functions that splitting this out into separate javascript files for ease of testing might be nice, but were you can just test the input/output of the whole job this works for me.</p>
<pre>KLASS = "this._type"
SECTION = "this.section"

def self.count_by(type)
  map = &lt;&lt;EOF
    function() {
      function truthy(value) {
        return (value == true) ? 1 : 0;
      }
      emit(#{type}, {type: #{type}, count: 1, published: truthy(this.is_published)})
    }
EOF

  reduce = &lt;&lt;EOF
    function(key, values) {
      var count = 0; published = 0;
      values.forEach(function(doc) {
        count += parseInt(doc.count);
        published += parseInt(doc.published);
        type = doc.type
      );
      return {type: type, count: count, published: published}
    }
EOF

  collection.mapreduce(map, reduce).find()

end
</pre>
<p>In our case that will return something like the following, or rather more specifically it will return a Mongo::Cursor that allows you to get at the following data.</p>
<pre>[{"_id"=&gt;"Publication", "value"=&gt;{"type"=&gt;"Publication", "count"=&gt;42.0, "published"=&gt;29.0}},
{"_id"=&gt;"LongerPublication", "value"=&gt;{"type"=&gt;"LongerPublication", "count"=&gt;12.0, "published"=&gt;10.0}}]
</pre>
<p>I&#8217;ve been pretty impressed with both Mongo and Mongoid here. I like the feel of mapreduce jobs for this sort of reporting task. In particular it&#8217;s suprising how writing two languages mixed together like this doesn&#8217;t really affect the readability of the code in my view. Given that with a relational database you&#8217;d probably be writing <span class="caps">SQL</span> anyway maybe that&#8217;s not that suprising &#8211; the syntactic differences between Javascript and Ruby are much smaller than pretty much anything and <span class="caps">SQL</span>. Lots of folks have written about the increase of polyglot programming, but I wonder if we&#8217;ll see an increase in the embedding of one language in another?</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/11/Rundeck-and-nagios-nrpe-checks/">Rundeck and Nagios Nrpe Checks</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-11T00:00:00+01:00" pubdate data-updated="true">Sep 11<span>th</span>, 2011</time>
        
         | <a href="/2011/09/11/Rundeck-and-nagios-nrpe-checks/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been playing with <a href="http://rundeck.org/">Rundeck</a> recently. For those that haven&#8217;t seen it yet it&#8217;s an application for running commands across a cluster of machines and recording the results. It has both a command line client and a very rich web interface which boths allows you to trigger commands and shows the results.</p>
<p>I&#8217;ve played with a few different jobs so far, including triggering Puppet runs across machines triggered by a Jenkins plugin. I&#8217;ve also been looking at running all my monitoring tasks at the click of a button (or again as part of a smoke test triggered by Jenkins) and I thought that might make a nice simple example.</p>
<p>My checks are written as Nagios plugins, and run periodically by Nagios. I also trigger them manually, using Dean&#8217;s <a href="http://www.unixdaemon.net/tools/commandline/introducing-nrpe-runner.html"><span class="caps">NRPE</span> runner script</a>.</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRiJoQIM" alt="Rundeck showing a job output"/></p>
<p>The above shows a successful run across a few machines I use for experimenting with tools. Hopefully you can see the summary of the run on each of the four machines, each ran five <span class="caps">NRPE</span> checks and all passed. On failure we&#8217;d see the results as well as different symbols and colous. We can easily save the output to a file if we need to, rerun or duplicate the job (maybe to have it run against a different group of machines) or we can export the job definition file to load into another instance.</p>
<p>The same job can also be run on the command line (which makes use the of Rundeck <span class="caps">API</span>)</p>
<pre>./run -j "Run NRPE checks" -p PRGMR</pre>
<p>This example shows running a specific pre-defined job, but it&#8217;s also equally possible to fire of adhoc commands to some or all of the machines rundeck knows about.</p>
<p>One thing in particular that I prefer about this approach to say using Capistrano or Fabric for remote execution tasks is that you have a centralised authentication and logging capability. It would be easy enough to encapsulate the jobs into cap or fabric tasks (and manage that in source control) which means you&#8217;re not stuck if Rundeck isn&#8217;t available.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/08/19/On-her-majestys-digital-service/">On Her Majesty&#8217;s Digital Service</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-19T00:00:00+01:00" pubdate data-updated="true">Aug 19<span>th</span>, 2011</time>
        
         | <a href="/2011/08/19/On-her-majestys-digital-service/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This blog post is mainly an excuse to use the pun in the title. It&#8217;s also an opportunity to tell folks that don&#8217;t already know I&#8217;ll be starting a new job on Monday working for the UK Government. I&#8217;m going to be work for the <a href="http://digital.cabinetoffice.gov.uk/">Government Digital Service</a>, a new department tasked with a pretty wide range of sorting the Government out online.</p>
<p>The opportunity is huge. And when it came around I couldn&#8217;t turn it down. I&#8217;m going to be working with a bunch of people I&#8217;ve <a href="http://memespring.co.uk/">known</a> <a href="http://nicepaul.com/">and</a> <a href="http://fberriman.com/">respected</a> for a while, as well as other equally smart people. That means I&#8217;m going to be back in London again as well.</p>
<p>Hopefully I&#8217;ll be able to talk lots about what we&#8217;re up to. The groundwork for that has already been laid by the <a href="http://alpha.gov.uk">alpha.gov</a> team who have been blogging furiously about topics of interest.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/08/11/Talking-configuration-management-vagrant-and-chef-at-lrug/">Talking Configuration Management, Vagrant and Chef at Lrug</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-11T00:00:00+01:00" pubdate data-updated="true">Aug 11<span>th</span>, 2011</time>
        
         | <a href="/2011/08/11/Talking-configuration-management-vagrant-and-chef-at-lrug/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I stepped in at the last minute to do a talk at the last London Ruby User Group. From the feedback afterwards folks seemed to enyoy it and I certainly had fun. Thanks to everyone who came along.</p>
<p><object id="__sse8828889" width="595" height="497"> <param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=configmanagamentfordevelopmentenvironmentsii-110811103611-phpapp02&rel=0&stripped_title=config-managament-for-development-environments-ii&userName=garethr" /> <param name="allowFullScreen" value="true"/> <param name="allowScriptAccess" value="always"/> <embed name="__sse8828889" src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=configmanagamentfordevelopmentenvironmentsii-110811103611-phpapp02&rel=0&stripped_title=config-managament-for-development-environments-ii&userName=garethr" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="595" height="497"></embed> </object></p>
<p>As well as the slides the nice Skills Matter folks have already uploaded the <a href="http://skillsmatter.com/podcast/home/chef-vagrant">videos from the night</a>.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/07/31/Vim-with-ruby-support-using-homebrew/">Vim With Ruby Support Using Homebrew</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-31T00:00:00+01:00" pubdate data-updated="true">Jul 31<span>st</span>, 2011</time>
        
         | <a href="/2011/07/31/Vim-with-ruby-support-using-homebrew/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve spend a bit of time this weekend cleaning, tidying and upgrading software on my mac. While doing that I got round to compiling my own Vim. I&#8217;d been meaning to do this for a while, I prefer using Vim in a terminal to using MacVim, and I like having access to things like <a href="http://www.vim.org/scripts/script.php?script_id=3025">Command-T</a> which requires Ruby support which the inbuild version lacks.</p>
<p>Vim isn&#8217;t in Homebrew, because Homebrew&#8217;s policy is to not provide duplicates of already installed software. Enter <a href="https://github.com/adamv/homebrew-alt">Homebrew Alt</a> which provides formulas for anything not allowed by the homebrew policy. As luck would have it a <a href="https://github.com/adamv/homebrew-alt/blob/master/duplicates/vim.rb">Vim Formula</a> already exists. And installing from it couldn&#8217;t be easier.</p>
<pre>brew install https://raw.github.com/adamv/homebrew-alt/master/duplicates/vim.rb</pre>
<p>As it turns out this failed the first time I ran it because I had an rvm installed Ruby on my path. I reset this to the system version and everything compiled fine.</p>
<pre>rvm use system</pre>
<p>Note also that it&#8217;s really quite simple to use a different revision or different flags when compiling. Just download that file, modify it, serve it locally (say with a python one line web server) and point brew install at it. Next step, running off head for all the latest and greatest Vim features.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/07/24/Jenkins-build-pipeline-example/">Jenkins Build Pipeline Example</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-24T00:00:00+01:00" pubdate data-updated="true">Jul 24<span>th</span>, 2011</time>
        
         | <a href="/2011/07/24/Jenkins-build-pipeline-example/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The idea of a build pipeline for web application deployment appears to have picked up lots of interest from the excellent <a href="http://continuousdelivery.com/">Continuous Delivery</a> book. Inspired by that, some nice folks have build an excellent plugin for Jenkins unsurprisingly called the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Build+Pipeline+Plugin">Build Pipeline Plugin</a>. Here&#8217;s a quick example of how I&#8217;m using it for one of my projects*.</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRihmQIM" alt="Build pipeline example in Jenkins"/></p>
<p>The pipeline is really just a visualisation of up and downstream builds in Jenkins given a starting point, plus the ability to setup manual steps rather than just the default build after ones. That means the steps are completely up to you and your project. In this case I&#8217;m using:</p>
<ol>
	<li>Build &#8211; downloads the latest code and any dependencies. You could also create a system package here if you like. If successful triggers&#8230;</li>
	<li>Staging deploy &#8211; In this case I&#8217;m using capistrano, but it could easily have been rsync, fabric or triggering a chef or puppet run. If successful triggers&#8230;</li>
	<li>Staging test &#8211; This is a simple automated test suite that checks that the site on staging is correct. The tests are bundled with the code, so are pulled down as part of the build step. If the tests pass&#8230;</li>
	<li>Staging approval &#8211; This is one of the clever parts of the plugin. This jenkins job actually does nothing except log it&#8217;s successful activation. It&#8217;s only run when I press the Trigger button on the pipeline view. This acts as a nice manual gate for a once over check on staging.</li>
	<li>Production deploy &#8211; using the same artifact as deployed to staging this job triggers the deploy to the production site again via capistrano</li>
</ol>
<p>I&#8217;m triggering builds on each commit too via a webhook. But I can also kick off a build by clicking the button the pipeline view if I need to.</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRi5kQIM" alt="Pipeline example showing build in progress"/></p>
<p>Note that I&#8217;m only allowing the last build to be deployed given only that one can be checked on staging. Again this is configuration specific to my usage, the plugins lets you operate a number of different ways. There are a number of tweaks I want to make to this, mainly around experimenting with parameterized builds to pass useful information downstream and even allow parrallel execution. For the moment I have the <em>Block build when upstream project is building</em> flag checked on the deploy.</p>
&nbsp;* Yes, this is a one page site. With a 5 step build process in Jenkins including a small suite of functional tests and a staging environment. This is what we call overengineering.</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/07/07/Varnish-at-refresh-cambridge/">Varnish at Refresh Cambridge</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-07T00:00:00+01:00" pubdate data-updated="true">Jul 7<span>th</span>, 2011</time>
        
         | <a href="/2011/07/07/Varnish-at-refresh-cambridge/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I did a quick lightning talk at the Refresh Cambridge meetup last night, a very quick introduction to <a href="https://www.varnish-cache.org/">Varnish</a>. Given 10 minutes all I really wanted to do was get people to go away and take a look at it. Lots of folks in the room hadn&#8217;t come across it before so I think the talk was hopefully well pitched.</p>
<p><iframe src="http://www.slideshare.net/slideshow/embed_code/8531073?rel=0" width="510" height="426" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe></p>
<p>Several people asked about slighly dynamic pages and I only got chance to mention support for <a href="https://www.varnish-cache.org/trac/wiki/ESIfeatures"><span class="caps">ESI</span></a> (Edge Side Includes) at the end. Conversation afterwards turned to various parts of the modern web stack and I had a pretty good time being opinionated. Hopefully more of the same next month.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/30/Django-performance-1-measuring-performance/">Django Performance Patterns 1: Measuring Performance</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-30T00:00:00+01:00" pubdate data-updated="true">Jun 30<span>th</span>, 2011</time>
        
         | <a href="/2011/06/30/Django-performance-1-measuring-performance/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Preface</h2>
<p>As Django has matured it&#8217;s being used for bigger and bigger projects. At the same time it&#8217;s also being used by more and more people building relatively simple applications quickly. Everyone&#8217;s application is different, but I&#8217;d wager the vast majority of these have a range of common performance problems. Performance is often something only larger teams get to spend time really getting to grips with. This is sometimes because smaller projects can&#8217;t afford the time, or more often probably that things are thought to be <em>fast enough</em> anyway.</p>
<p>One advantage of using a framework is the sharing of common solutions to common problems that happens as a community forms. In what is hopefully going to be a bit of a series I&#8217;m going to cover some simple things everyone can do to improve application performance. The patterns are generally applicable, but I&#8217;m going to focus on Django examples.</p>
<p>I&#8217;m going to be pretty opinionated about the stack I&#8217;m using when necessary. I&#8217;m not looking to compare different web servers or databases or python versions. And I&#8217;d rather give concrete examples than generalise. If you&#8217;re using a different stack that&#8217;s fine, somethings will just work and others will need you to know how to configure the software you&#8217;ve already chosen. I&#8217;m also going to focus on a very small and simple to understand application. Most of these techniques scale up just fine, but I feel people don&#8217;t often use them on smaller projects because they thing you can <em>only</em> use them on larger ones. Or that you won&#8217;t see much impact on a smaller project. Both of these don&#8217;t ring true in my opinion and I&#8217;ll hopefully show why.</p>
<h2>Measuring Performance</h2>
<p>In this first part of the series lets take a quick detour to frame everything else. Lets talk about ways we can measure performance so we can see if the changes we&#8217;re making have the desired impact. If you&#8217;re not measuring performance already then start here.</p>
<p>We&#8217;ll start out looking at a few tools which are useful when taking a view by view approach to analysing performance. These generally ignore the impact of load on the system but because of this are generally easier to understand and read.</p>
<h2>Django Debug Toolbar</h2>
<p>Most Django developers will hopefully already be using the excellent <a href="">Debug Toolbar</a>. It has a number of features relevant to our current quest but the most interesting is the query count. Less queries is nearly always better. That&#8217;s a whopping generalisation, but looking for unnecessary queries or duplicated queries or particularly slow running queries is a great way of making your application faster. The <span class="caps">ORM</span> makes it pretty easy to end up with a querysplosion if you&#8217;re not paying attention.</p>
<p>It&#8217;s very simple to install:</p>
<pre>pip install django-debug-toolbar</pre>
<p>The query section shows you the number of queries, the individual queries themselves and the time taken. It&#8217;s designed to be run in debug mode, so the actual query times will likely be lower in production, but the query that&#8217;s taking ages in development will probably still be slow when you go live.</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRiB-gEM" alt="Django debug toolbar"/></p>
<h2>YSlow</h2>
<p><a href="http://developer.yahoo.com/yslow/">YSlow</a> is a browser extension for Firefox and Chrome that gives information and recommendations about a number of mainly <span class="caps">HTTP</span>, <span class="caps">CSS</span> or javascript issues individual pages might have. It will give you a score as well as suggestions for improvement:</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRiC-gEM" alt="YSlow showing a score of 96"/></p>
<p>Also useful is the break down of the number of <span class="caps">HTTP</span> requests, and the affect of a primed cache on page loading.</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRjpgQIM" alt="YSlow showing http request breakdown"></p>
<h2>Profiling Middleware</h2>
<p>Sometimes you want to know the very low level calls that go into making a page render. For this you&#8217;ll want to look at profiling tools. The Django wiki has a <a href="https://code.djangoproject.com/wiki/ProfilingDjango">useful page on profiling</a> which is good if dispiriting reading.</p>
<p>Django Snippets has several profiling middleware, one of which is packaged up in the excellent <a href="http://pypi.python.org/pypi/django-snippetscream">Django Snippetscream</a>. We can install that like so:</p>
<pre>pip install django-snippetscream</pre>
<p>Just include the middleware in your debug environment:</p>
<pre>MIDDLEWARE_CLASSES = MIDDLEWARE_CLASSES + ('snippetscream.ProfileMiddleware',)</pre>
<p>You can then append ?prof to any of your URLs and instead of seeing the view you&#8217;ll see something like the following:</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRjRiQIM" alt="Profiling view"/></p>
<p>Look at where your code spends it&#8217;s time and whether you have repeated calls to the same methods and functions. Sometimes getting down to this level of detail is the easiest way of finding the bottleneck in your application.</p>
<h2>Nginx Logging</h2>
<p>Here&#8217;s the first time I&#8217;m being opinionated about the stack, by choosing Nginx as my frontend server. I&#8217;ll talk a little about why this is a good idea later, but for the moment lets concentrate on why this is useful for measuring performance.</p>
<p>Log files are wonderful things, and Nginx has quite a powerful syntax for <a href="http://wiki.nginx.org/HttpLogModule">adding extra information to log files</a>. Note the last line in the definition below.</p>
<pre>log_format timed_combined '$remote_addr - $remote_user [$time_local]  '
      '"$request" $status $body_bytes_sent '
      '"$http_referer" "$http_user_agent" '
      '$request_time $upstream_response_time $gzip_ratio';</pre>
<p>We are adding the entire request time, the time taken by the upstream server (in my case gunicorn) to respond and also the gzip ratio. This is really handy if you&#8217;re optimising an application already in production. By collecting this data here it&#8217;s easy to then analyse the logs and pull out things like slow urls or assets not being gzipped effectively.</p>
<h2>Django Timelog</h2>
<p>Very similar to the above nginx logging, but implemented as a django 1.3 application (so it can be used in development as well) is one of my projects, <a href="https://github.com/garethr/django-timelog">django-timelog</a>. As well as logging the time taken for each request, django-timelog provides a management command to analyse the resulting log file. It produces output which can show in aggregate the average response time of either views or individual URLs.</p>
<pre>
+--------------------------+--------+--------+-------+---------+---------+-------+-------+
| view                     | method | status | count | minimum | maximum | mean  | stdev |
+--------------------------+--------+--------+-------+---------+---------+-------+-------+
| boxes.viewsBoxDetailView | GET    | 200    | 9430  | 0.14    | 0.28    | 0.21  | 0.070 |
+--------------------------+--------+--------+-------+---------+---------+-------+-------+
| boxes.viewsBoxListView   | GET    | 200    | 66010 | 0.17    | 0.28    | 0.232 | 0.045 |
+--------------------------+--------+--------+-------+---------+---------+-------+-------+
| django.views.staticserve | GET    | 200    | 61295 | 0.00    | 0.02    | 0.007 | 0.006 |
+--------------------------+--------+--------+-------+---------+---------+-------+-------+
</pre>
<p>It&#8217;s packaged so installation should be straightforward.</p>
<pre>pip install django-timelog</pre>
<p>Again this can be used in a production environment, or it can be used locally while developing. You can also use load testing tools as described in a moment to generate traffic which is then logged.</p>
<h2>Load Testing</h2>
<p>I&#8217;m mainly looking for a tool here which can easily generate <span class="caps">HTTP</span> traffic in volume, sending a decent number of concurrent requests against your application and returning some useful results. I mainly turn to ab (<a href="http://httpd.apache.org/docs/2.0/programs/ab.html">Apache bench</a>) because it&#8217;s available everywhere and it&#8217;s very simple to use.</p>
<p>For example lets hit a site with 100 requests, with requests being sent in batches of 5.</p>
<pre>ab -c 5 -n 100 http://www.vagrantbox.es/12/</pre>
<p>This will print something like the following. For our purposes we&#8217;re mainly interested in the requests per second value and the mean request time.</p>
<pre>Concurrency Level:      5
Time taken for tests:   1.981 seconds
Complete requests:      100
Failed requests:        0
Write errors:           0
Total transferred:      328300 bytes
HTML transferred:       297400 bytes
Requests per second:    50.47 [#/sec] (mean)
Time per request:       99.064 [ms] (mean)
Time per request:       19.813 [ms] (mean, across all concurrent requests)
Transfer rate:          161.82 [Kbytes/sec] received</pre>
<p>Load testing is a pretty large topic. For instance even with the above simple example how do we know if 100 requests is enough? (it&#8217;s not.) Or whether a concurrency of 5 is useful? Often what you&#8217;re interested in is where your application starts to saturate or where it starts to error. But even without getting bogged down in the details a simple test like this can show changes have had a positive or negative effect. I&#8217;ll show examples of this as we investigate optimisation techniques.</p>
<p>If you&#8217;re working on a larger project hopefully you&#8217;ll have the time to investigate other approaches too. I&#8217;m quite a fan of using production logs to replay requests for instance, and of using <a href="http://funkload.nuxeo.org/">Funkload</a> for running scenarios under load. I&#8217;ll hopefully write more about those later. I&#8217;ve heard good things about <a href="http://tsung.erlang-projects.org/">Tsung</a> as well, <a href="http://www.hpl.hp.com/research/linux/httperf/">HTTPerf</a> is excellent and <a href="http://jakarta.apache.org/jmeter/">JMeter</a> has many fans. I&#8217;m using ab for examples because it&#8217;s point and shoot and you probably already have it installed without knowing.</p>

<p>Hopefully that&#8217;s a useful list of tools to get a baseline of where you&#8217;re at with performance. The rest of the articles in this series will show approaches to improve performance, and come back to one or more of these tools to confirm we&#8217;re heading in the right direction.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/26/New-ganglia-web-interface-improvements/">New Ganglia Web Interface Improvements</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-26T00:00:00+01:00" pubdate data-updated="true">Jun 26<span>th</span>, 2011</time>
        
         | <a href="/2011/06/26/New-ganglia-web-interface-improvements/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So I&#8217;m a huge <a href="http://ganglia.sourceforge.net/">Ganglia</a> fan. It&#8217;s my go-to tool for standard low level metrics and for more ad-hoc higher level stuff as well. So I&#8217;m very happy to see the <a href="http://ganglia.info/?p=393">newly released</a> version of the Ganglia Web interface.</p>
<p>Here&#8217;s the old look and feel:</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRiZ8gEM" alt="Old Ganglia UI"/></p>
<p>And here&#8217;s the new version:</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRix6gEM" alt="New Ganglia UI"/></p>
<p>The first thing that stands out to me is the wide range of new options. We have a navigation bar with items like search, views, agregate graphs, events and mobile. And we have dynamic date ranges, and filtering and sorting options for metrics.</p>
<ul>
	<li>Search is what you&#8217;d expect. A search as you type facility for hosts and metrics, great if you have a large cluster and want to find something quickly.</li>
	<li>Views are interesting. Basically a way of putting together a specific set of metrics on one screen and linking to them, rather than always having to go via the node or grid overview.</li>
	<li>You could always create agregate graphs in Ganglia, but you had to delve into writing some <span class="caps">PHP</span> to get what you wanted. Not you can do certain types of graph on the fly, simply by specifying what you want.</li>
	<li>I&#8217;m cheating slightly here and using the very latest code rather than the 2.0.0 release. But it&#8217;s worth it for the Events feature. Events gives you the ability to record events like a deploy or a daily backup onto your graphs, immediately making some types of diagnosis easier. More about how I&#8217;m using this when I finish automating it.</li>
	<li>Gnaglia always worked OK on a mobile device mainly because all you really wanted was the graphs. The new mobile UI however just makes navigating much easier. It&#8217;s not yet doing device detection and automatically redirecting my iphone to that view which would be nice but it&#8217;s definately a good addition.</li>
	<li>Combined with views, automatic rotation shows a series of graphs, one every 30 seconds. Particularly useful for big screen dashboards, in fact I&#8217;ve built this exact feature before more than once before.</li>
</ul>
<p>I&#8217;ve concentrated here on the new visual features, but the new UI also contains <span class="caps">CSV</span> and <span class="caps">JSON</span> output for all metrics as well as a much easier <span class="caps">JSON</span> based approach to defining custom metrics. The amount of stuff in this release is huge. Massive thanks to the folks behind all the new features, in particular <a href="http://vuksan.com/">Vladimir Vuksan</a>.</p>
<p>Ganglia is such a staple that I&#8217;m used to just using whatever is in the latest distro provided packages. When it comes to the web UI however I&#8217;m going to make an exception from now on. Not only can you run the new UI in parallel with the old, deployment is simply copying a directory into place (It&#8217;s easy to forget just how simple <span class="caps">PHP</span> deployment is sometimes). If you&#8217;re already using Ganglia spend a few minutes installing the new UI. If you&#8217;ve rejected Ganglia previously because it didn&#8217;t have one feature or another then now is the time to look again.</p></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/page/2/">Newer &rarr;</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo">
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'morethanseven';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
