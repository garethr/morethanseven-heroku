
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Morethanseven</title>
  <meta name="author" content="Gareth Rushgrove">

  
  <meta name="description" content="I&#8217;ve been doing some basic performance profiling work with Ruby on Rails recently and one tool I found very useful was the request log analyzer &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.morethanseven.net/page/4">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/articles.atom" rel="alternate" title="Morethanseven" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<meta content="etkmKMftqAyYJM6-DP_TTKJjV0EHM5vbVcaOloSo8Z8" name="google-site-verification">
<link href="http://www.myopenid.com/server" rel="openid.server">
<link href="http://garethr.myopenid.com/" rel="openid.delegate">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-435455-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header>
<hgroup>
<h1><a href="/">Morethanseven</a></h1>
<p>The blog of Gareth Rushgrove</p>

<div id='carbonads-container'>
  <div class='carbonad'>
    <div id='carbon'></div>
    <script type='text/javascript'>
      //<![CDATA[
        var z = document.createElement("script");
        z.type = "text/javascript";
        z.async = true;
        z.src = "http://engine.carbonads.com/z/12119/carbon_2_1_0_HORIZ";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(z, s);
      //]]>
    </script>
  </div>
</div>

</hgroup>
</header>


  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/09/Logging-django-performance/">Logging Django Performance</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-09T00:00:00+01:00" pubdate data-updated="true">Jun 9<span>th</span>, 2011</time>
        
         | <a href="/2011/06/09/Logging-django-performance/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been doing some basic performance profiling work with Ruby on Rails recently and one tool I found very useful was the <a href="https://github.com/wvanbergen/request-log-analyzer">request log analyzer</a>. It&#8217;s a relatively simple command line application that you can point at the Rails application log files and it outputs lots of information in agregate. So information about request duration averages or about <span class="caps">SQL</span> queries run. When working on a recent Django project I wanted a tool to do the same thing and ended up writing timelog.</p>
<p>I did a bit of research to see if I could find something similar. Here are a few other interesting tools that didn&#8217;t quite do what I wanted:</p>
<ul>
	<li><a href="https://github.com/jmoiron/django-slow-log">Django Slow Log</a> &#8211; This logs things like memory and load averages</li>
	<li><a href="https://github.com/lamby/django-dumpslow">Django Dump Slow</a> &#8211; Similar but designed to just log slow requests rather than everything, also needs a Redis backend</li>
	<li><a href="https://github.com/jbalogh/zamboni/blob/master/apps/amo/middleware.py#L162">Zamboni Middleware</a> &#8211; This is very similar to what I wanted, but it&#8217;s not a separate module and I didn&#8217;t find anything to analyse the results</li>
</ul>
<p>Timelog is very similar to the middleware in Zamboni, the only real difference being I&#8217;m using the new logging support in Django 1.3. More interesting is the bundled management command which will output something like:</p>
<pre>
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
| view                     | method | status | count | minimum | maximum | mean  | stdev           |
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
| boxes.viewsBoxDetailView | GET    | 200    | 9430  | 0.14    | 0.28    | 0.21  | 0.0700037118541 |
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
| boxes.viewsBoxListView   | GET    | 200    | 66010 | 0.17    | 0.28    | 0.232 | 0.0455415351076 |
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
| django.views.staticserve | GET    | 200    | 61295 | 0.00    | 0.02    | 0.007 | 0.0060574669888 |
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
</pre>
<p>At the moment I&#8217;ve not done any real benchmarking or optimisation of the script, but it will chew through a 300,000 line (20MB) log file in under 20s on my aging macbook.</p>
<p>The code for Timelog is on github at <a href="http://github.com/garethr/django-timelog">github.com/garethr/django-timelog</a> and I&#8217;ve uploaded to PyPi as well at <a href="http://pypi.python.org/pypi/django-timelog">pypi.com/django-timelog</a>. You can install it with the usual tools like pip:</p>
<pre>pip install django-timelog</pre>
<p>Once installed you need to do a little configuration to get things working. First add the middleware to your MIDDLEWARE_CLASSES in your settings file.</p>
<pre>
MIDDLEWARE_CLASSES = (
  'timelog.middleware.TimeLogMiddleware',
</pre>
<p>Next add timelog to your INSTALLED_APPS list. This is purely for the management command discovery.</p>
<pre>
INSTALLED_APPS = (
  'timelog',
</pre>
<p>Then configure the logger you want to use. This really depends on what you want to do, the django 1.3 logging setup is pretty powerful. Here&#8217;s how I&#8217;ve got logging setup as an example:</p>
<pre>
TIMELOG_LOG = '/path/to/logs/timelog.log'

LOGGING = {
  'version': 1,
  'formatters': {
    'plain': {
      'format': '%(asctime)s %(message)s'},
    },
  'handlers': {
    'timelog': {
      'level': 'DEBUG',
      'class': 'logging.handlers.RotatingFileHandler',
      'filename': TIMELOG_LOG,
      'maxBytes': 1024 * 1024 * 5,  # 5 MB
      'backupCount': 5,
      'formatter': 'plain',
    },
  },
  'loggers': {
    'timelog.middleware': {
      'handlers': ['timelog'],
      'level': 'DEBUG',
      'propogate': False,
     }
  }
}
</pre>
<p>In order for the analyser script to work correctly you&#8217;ll need to use the plain formatter and to register a handler for the timelog.middleware logger.</p>
<p>With that all configured try hitting your application a few times. You should see a log file created at the location specified in TIMELOG_LOG. Fill that up with a few lines and then run the analyze_timelog management command:</p>
<pre>python manage.py analyze_timelog</pre>
<p>This should output something similar to the above table but with your timings and views. The management command currently allows you to point the analyzer at a different file say from a backup, or a file you&#8217;ve pulled down from production but want to run the command locally. I&#8217;ll likely add some filters as time permits for things like not showing all views or showing only views between a given date range.</p>
<p>The above table showing the view function is good for big picture trends, but if you want to dig down into a particular path then you can pass an argument to not reverse the path:</p>
<pre>python manage.py analyze_timelog --noreverse</pre>
<p>This should give you something more like:</p>
<pre>
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| view                             | method | status | count | minimum | maximum | mean  | stdev            |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| /assets/css/main.css             | GET    | 200    | 61295 | 0.00    | 0.02    | 0.007 | 0.0060574669888  |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| / bob                            | GET    | 404    | 4715  | 0.01    | 0.01    | 0.01  | 0.0              |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| /                                | GET    | 200    | 66010 | 0.17    | 0.28    | 0.232 | 0.0455415351076  |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| /__debug__/m/css/toolbar.min.css | GET    | 304    | 4715  | 0.00    | 0.00    | 0.0   | 0.0              |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| /14/                             | GET    | 200    | 9430  | 0.14    | 0.28    | 0.21  | 0.0700037118541  |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
</pre></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/04/Getting-http-headers-right/">Debugging HTTP Headers With RedBot</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-04T00:00:00+01:00" pubdate data-updated="true">Jun 4<span>th</span>, 2011</time>
        
         | <a href="/2011/06/04/Getting-http-headers-right/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been using the <a href="http://www.vagrantbox.es">Vagrantbox.es</a> site as a bit of a playground recently and I&#8217;ve been meaning to blog about some of the overengineering I&#8217;ve been doing. Here&#8217;s a smaller starter.</p>
<p>Getting the headers returned by your web server correct is both easy to do and easy to forget about. Unless you go actively looking for headers with curl or similar you&#8217;ll probably miss them, and even then will you spot an incorrect header by eye? <a href="http://redbot.org">RedBot</a> is an excellent online tool that not only shows you the headers but makes recommendations about what might be missing, invalid or things you haven&#8217;t considered.</p>
<p>For instance the <a href="http://redbot.org/?uri=http%3A%2F%2Fwww.vagrantbox.es">RedBot results for vagrantbox.es</a> look like this:</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRjJ4gEM" alt="Debugging information from Redbot"/></p>
<p>Or at least they do now after a few tweaks to my nginx configuration. In particular I&#8217;ve added</p>
<pre>add_header Vary Accept-Encoding;</pre>
<p>I&#8217;d assumed that enabling gzip compression with gzip_vary would have set this automatically and never checked. The way RedBot provides a checklist of recommendations is very handy.</p>
<p>As well as checking the page itself you can also check all the assets associated with a page by adding a query string argument. For instance here is the <a href="http://redbot.org/?descend=True&amp;uri=http://www.vagrantbox.es">assets view for Vagrantbox.es</a>. RedBot also provides a <a href="http://redbot.org/?id=o5GXZe&amp;descend=True&amp;format=har"><span class="caps">JSON</span> encoded version of the result</a> which might be useful in a CI system. If you&#8217;d rather run your own instance of the software you can, the code can be found on github at <a href="http://mnot.github.com/redbot/">mnot.github.com/redbot/</a>. It currently doesn&#8217;t work with <span class="caps">HTTPS</span> resources but that&#8217;s about the only thing I&#8217;d like to see added.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/05/15/Python-on-cloudfoundry/">Python on Cloudfoundry</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-15T00:00:00+01:00" pubdate data-updated="true">May 15<span>th</span>, 2011</time>
        
         | <a href="/2011/05/15/Python-on-cloudfoundry/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For those that haven&#8217;t yet had a look <a href="http://cloudfoundry.com/">Cloudfoundry</a> from VMware is two things, one of which is nice, one of which is very cool indeed:</p>
<ul>
	<li>On one hand it&#8217;s a platform as a service, allowing you to easily deploy Ruby, Java and Node.js applications to <a href="http://cloudfoundry.com/">cloudfoundry.com</a>.</li>
	<li>On the other hand it&#8217;s an <a href="http://cloudfoundry.org/">open source project</a> with all the code on <a href="http://github.com/cloudfoundry">Github</a> allowing you to run the entire stack wherever you like.</li>
</ul>
<p>I&#8217;m pretty interested in the latter. Its <span class="caps">API</span> could in theory become a defacto standard for application and service buildouts, in the same way as we&#8217;re seeing the EC2 <span class="caps">API</span> expand outside <span class="caps">AWS</span> for managing infrastructure (and arguably how we&#8217;re using Chef and Puppet for managing the things installed on that infrastructure). The really interesting bit is the fact it&#8217;s all open source. Not only does that mean you can run it on your own infrastructure (including as I&#8217;m doing on a virtual machine on my laptop), but it&#8217;s also designed so new services (like Redis, MySQL, RabbitMQ), new runtimes (like Ruby 1.8, RUby 1.9, Java) and new frameworks (like Rails, Sinatra, Spring) can be added easily.</p>
<p>I&#8217;m running vcap on a <a href="http://vagrantup.com">vagrant</a> managed VirtualBox instance, but you could install it anywhere you like. I used <a href="https://github.com/auser/cloudfoundry-quickstart">these chef recipes</a> to get everything installed. I ran into an issue with the mysql service not starting correctly that <a href="https://github.com/auser/cloudfoundry-quickstart/pull/2">I fixed</a> and I needed to manually install chef into the rvm gemset part way through the install, but the recipes pretty much just worked.</p>
<p>Looking for an excuse to have a route through the vcap code I decided to see if I could add rudimentary support for Python applications. After a day of noodling around I&#8217;ve forked the code and sent a few pull requests back with it basically working. This required changes to the <a href="https://github.com/cloudfoundry/vmc/pull/18">vmc client</a>, to the <a href="https://github.com/cloudfoundry/vcap/pull/57">vcap service</a> and like all good open source contributions to the <a href="https://github.com/cloudfoundry/vcap-tests/pull/4">test suite</a>.</p>
<p>Thanks hugely to existing pull requests (mainly the one&#8217;s for <a href="https://github.com/cloudfoundry/vcap/pull/25">adding <span class="caps">PHP</span> support</a>) it&#8217;s not taken long at all. The Sinatra and Rails support which shipped with the first release from VMWare supports using Bundler to define gem dependencies that can be pulled in at deploy time. It shouldn&#8217;t be too much effort I&#8217;m hoping to do the same for using pip and virtualenv for each deployed python application. I think I can also see how to support python3 and how to add django as a supported framework.</p>
<p>I had huge fun, but you might not at this early stage in the project. I&#8217;m relatively happy with reading and writing Ruby, futzing with rvm, debugging installation woes and hunting down service configuration problems. The best tool for working out what was happening was generally tailing the logs in /tmp/vcap-run/ and finding the code that wrote a given message. If you just want something to work I&#8217;d wait a little while, if you like the sound of the above it&#8217;s a pretty nice codebase to play around in. I&#8217;d love to eventually see some official contributor documentation and some hints and tips on things like running the tests. At the moment flicking through reported issues and pull requests on GitHub is the best place to start.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/05/08/Vagrant-plugin-for-interacting-with-vagrantboxes/">Vagrant Plugin for Interacting With Vagrantbox.es</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-08T00:00:00+01:00" pubdate data-updated="true">May 8<span>th</span>, 2011</time>
        
         | <a href="/2011/05/08/Vagrant-plugin-for-interacting-with-vagrantboxes/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>After <a href="http://www.jedi.be/blog">Patrick</a> released <a href="https://github.com/jedi4ever/sahara/">Sahara</a>, a nifty extension for the <a href="http://vagrantup.com">Vagrant</a> command line tool, I&#8217;ve been meaning to put together a similar extension for interacting with the growing list of base boxes on <a href="http://www.vagrantbox.es">vagrantbox.es</a>.</p>
<p>After a bit of hacking this morning I&#8217;ve just pushed out an initial release of the <a href="https://rubygems.org/gems/vagrantboxes">vagrantboxes gem</a> and you can find the <a href="https://github.com/garethr/ruby-vagrantboxes">source code and some documentation on GitHub</a>.</p>
<p>The extensions adds a vagrantboxes namespace to the vagrant command line tool which provides a few useful commands. Specifically you can list all the available boxes, do text searches, show the full details of a box and most handily of all add a box that takes your fancy to your local base box store, all without having to worry about the URLs of the boxes if you don&#8217;t want to.</p>
<p>Here&#8217;s an example of a simple search:</p>
<pre>&gt;&gt; vagrant vagrantboxes search centos
3    centos 5.5                http://dl.dropbox.com/u/15307300/vagrant-0.7-centos-64-base.box
6    opscode centos 5          http://opscode-vagrant-boxes.s3.amazonaws.com/centos5-gems.box
7    opscode ubuntu 10.04      http://opscode-vagrant-boxes.s3.amazonaws.com/ubuntu10.04-gems.box
9    puppet centos 5.5 64      http://puppetlabs.s3.amazonaws.com/pub/centos5_64.box
10   puppet centos 4 64        http://puppetlabs.s3.amazonaws.com/pub/centos4_64.box
21   centos 5.6 32             http://yum.mnxsolutions.com/vagrant/centos_56_32.box</pre>
<p>And another quick example, this time of show printing the full description. In the future I might look to store more structured metadata and make this more useful.</p>
<pre>&gt;&gt; vagrant vagrantboxes show 18
puppet debian lenny 64
http://puppetlabs.s3.amazonaws.com/pub/debian_lenny_64.box

Debian Lucid 64 bit vagrant box. Puppet 2.6.6 installed and ready to provision using the Puppet provisioner in Vagrant.

For good sample modules, try the jeffmccune-motd and jeffmccune-mockbuild modules posted to http://forge.puppetlabs.com/

Created by Ken Barber, ken@puppetlabs.com</pre>
<p>This proved a good excuse to delve into the Vagrant source code which is pretty readable for the most part once you understand the libraries it&#8217;s build upon. It&#8217;s simple enough to extend for adding commands like this too, which bodes well for other more useful additions in the future.</p>
<p>If anyone has any problems with this extensions do let me know. Error handling currently consists of returning blank output rather than sensible error codes or messages, and as I&#8217;ve yet to add a small test suite so their might (will) be a few bugs lying around. I&#8217;ll try and make it better behaved in the next week or two but reasoned it&#8217;s useful straight away.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/05/07/Version-control-and-deployment-of-cron-jobs/">Version Control and Deployment of Cron Jobs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-07T00:00:00+01:00" pubdate data-updated="true">May 7<span>th</span>, 2011</time>
        
         | <a href="/2011/05/07/Version-control-and-deployment-of-cron-jobs/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A recent question on Twitter prompted me to write a quick blog post about managing cron jobs. As more and more people want to automate provisioning and deployment of web applications some, maybe previously manually managed, items come into the fold.</p>
<p>Cron jobs are interesting because you may prefer to see them as part of the infrastructure (like apache or mysql) or as part of your application code. I think both are valid, sometimes at the same time. For instance you might have a cron job which deals with scheduled database backups. All that requires is the database and the script to be present. At other times your cron jobs might require your entire application stack. For instance a rake task which uses a Rails application model, or a django management command.</p>
<h2>Configuration Management and Cron</h2>
<p>Both <a href="http://opscode.com/chef/">Chef</a> and <a href="http://puppetlabs.com/puppet/">Puppet</a> provide a cron resource type. This is particularly handy for things like database backup scripts or ganglia gmetric scripts. You probably want these scripts and cron jobs to be installed on machines that have the related software installed, and you&#8217;re probably already describing this in your Chef recipes or Puppet manifests. If you&#8217;re not already using one of these tools using them to manage just your cron jobs is a nice way of starting out.</p>
<p>Using the <a href="http://docs.puppetlabs.com/references/latest/type.html#cron">Puppet Cron Type</a> looks like this:</p>
<pre><code>cron { command:
  command =&gt; "/usr/local/sbin/command",
  hour =&gt; 2,
  minute =&gt; 0
}</code></pre>
<p>And the equivalent <a href="http://wiki.opscode.com/display/chef/Resources#Resources-Cron">Chef Reasource</a> looks like:</p>
<pre><code>cron "describe your job" do
  hour "2"
  minute "0"
  command "/usr/local/sbin/command"
end</code></pre>
<p>The important part is that by describing your cron jobs in code you can then version control them easily, and both Chef and Puppet have mechanisms to push these jobs out to be installed by the relevant hosts. With cron jobs you might not want all your machines to be running the same jobs for instance.</p>
<h2>Using Whenever</h2>
<p>An alternative, or complimentary, approach to versioning and deploying cron jobs would be to tie it in with your application code. This makes sense when those jobs are tightly coupled to your application, for instance rails specific rake tasks or django management commands. <a href="https://github.com/javan/whenever">Whenever</a> is a tool I&#8217;ve been using recently that makes this pretty simple. You describe your cron jobs in a file called schedule.rb like so:</p>
<pre><code>every 3.hours do
  command "/usr/local/sbin/command"
end</code></pre>
<p>And then running the provided whenever command line application will generate a working crontab. Whenever ships with capistrano integration and some useful shortcuts for running rake tasks or accessing Ruby code, but it&#8217;s simple to write your own command shortcuts without having to write ruby code too.</p>
<h2>Other Approaches</h2>
<p>I have seen some tools which replace cron completely, but I&#8217;ve never liked that idea much. Cron works pretty well, and is clever enough to deal with things like daylight saving time and leap years inteligently if needed. I know other folks who are centralising all regular jobs into something like Jenkins. I can see advantages to that, although I&#8217;ve yet to find a really nice way of automating this outside the gui interface or manually modifying configuration files.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/04/29/Creating-a-cucumber-nagios-package-with-fpm/">Creating a Cucumber Nagios Package With Fpm</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-04-29T00:00:00+01:00" pubdate data-updated="true">Apr 29<span>th</span>, 2011</time>
        
         | <a href="/2011/04/29/Creating-a-cucumber-nagios-package-with-fpm/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve written <a href="http://morethanseven.net/2011/01/16/Why-developers-should-care-about-system-packages.html">before</a> about why I like System Packages, but even I&#8217;ll admit that the barriers to creating them mean I don&#8217;t use them for everything. <a href="https://github.com/jordansissel/fpm"><span class="caps">FPM</span></a> however is making it much easier, to the point where I&#8217;m starting to create a few packages I can reuse on projects. I thought a write up of how I&#8217;m doing that for <a href="http://cucumber-nagios.org/">Cucumber-Nagios</a> might be useful.</p>
<p>For those that haven&#8217;t seen it yet, <span class="caps">FPM</span> (or Effing Package Management) is a tool that helps you build packages, like RPMs and DEBs, quickly. It can take in gems, python packages, node.js npm files or just plain directories and make files and from that create you one or more system packages. Lets have a look at a full example with a Ruby gem.I really like using cucumber-nagios, whatever platform or language I happen to be using at the time. I have a number of Django projects for instance with cucumber-nagios checks, so being able to not worry about most of the Ruby install is useful.</p>
<p>In order to use <span class="caps">FPM</span> you&#8217;ll need to install it. It&#8217;s available as a Ruby gem so lets start there. I&#8217;m not going to delve into setting up a Ruby Gems environment as it&#8217;s annoying and covered for most platforms elsehere on the internet.</p>
<pre><code>gem install fpm</code></pre>
<p>First off lets install the cucumber-nagios gem, along with all it&#8217;s dependencies, into a local folder on my build machine. This might be a virtual machine or a separate machine in your cluster. It should be running the same OS as the intended production machines however. The following examples are from Ubuntu, but it&#8217;s much the same for <span class="caps">RPM</span> based distros.</p>
<pre><code>gem install --no-ri --no-rdoc --install-dir ~/tmp/gems cucumber-nagios</code></pre>
<p>Cucumber-nagios has a large number of dependencies, so we&#8217;re going to need to create packages for all of those too. <span class="caps">FPM</span> will cleverly deal with maintaining the specified dependencies thought. We&#8217;ll use find to do this quickly, and then instruct <span class="caps">FPM</span> to convert from a gem to a deb. You could obviously do this line by line if you prefer.</p>
<pre><code>find ~/tmp/gems/cache -name '*.gem' | xargs -rn1 fpm -s gem -t deb -a all</code></pre>
<p>That should leave us with lots of new .deb files that we can have a closer look at:</p>
<pre><code>dpkg --info rubygem-cucumber-nagios_0.9.0_i686.deb
dpkg -c rubygem-cucumber-nagios_0.9.0_i686.deb</code></pre>
<p>If you already have a private apt repository set up then just upload these packages and away you go. I&#8217;d like to use apt for installing them so I can leave it to manage all the dependencies easily. If not then I&#8217;ll show you briefly how to create a local file system repo, it&#8217;s not much more work to create a shared repo available over <span class="caps">HTTP</span>.</p>
<p>First create a directory to store our packages and move our newly created .deb files into it. You&#8217;ll need to be able to execute some of these commands as root but given the topic I&#8217;m assuming you&#8217;ll be able to deal with that.</p>
<pre><code>mkdir /usr/local/repo
cp *.all.deb /usr/local/repo</code></pre>
<p>For the next part you&#8217;ll need to install the dpkg development tools, and then create a file that can be read by apt when it&#8217;s looking for packages it can install.</p>
<pre><code>apt-get install dpkg-dev
dpkg-scanpackages /usr/local/repo /dev/null | gzip -9c &gt; /usr/local/repo/Packages.gz</code></pre>
<p>Now add your new package repo to your apt sources and update your package cache.</p>
<pre><code>/etc/apt/sources.list
deb file:/usr/local/repo ./
apt-get update</code></pre>
<p>At this point everything should be up and running. Let&#8217;s do a search in our repo:</p>
<pre><code>apt-cache search rubygem-
rubygem-amqp - AMQP client implementation in Ruby/EventMachine
rubygem-builder - Builders for MarkUp.
rubygem-bundler - The best way to manage your application's dependencies
rubygem-cucumber - cucumber-0.10.2
rubygem-cucumber-nagios - Systems testing plugin for Nagios using Cucumber.
rubygem-diff-lcs - Provides a list of changes that represent the difference between two sequenced collections.
rubygem-eventmachine - Ruby/EventMachine library
rubygem-extlib - Support library for DataMapper and Merb
rubygem-gherkin - gherkin-2.3.6
rubygem-highline - HighLine is a high-level command-line IO library.
rubygem-json - JSON Implementation for Ruby
rubygem-mechanize - The Mechanize library is used for automating interaction with websites
rubygem-net-ssh - Net::SSH: a pure-Ruby implementation of the SSH2 client protocol.
rubygem-nokogiri - Nokogiri (鋸) is an HTML, XML, SAX, and Reader parser
rubygem-rack - a modular Ruby webserver interface
rubygem-rack-test - Simple testing API built on Rack
rubygem-rspec - rspec-2.5.0
rubygem-rspec-core - rspec-core-2.5.1
rubygem-rspec-expectations - rspec-expectations-2.5.0
rubygem-rspec-mocks - rspec-mocks-2.5.0
rubygem-templater - Templater has the ability to both copy files from A to B and also to render templates using ERB
rubygem-term-ansicolor - Ruby library that colors strings using ANSI escape sequences
rubygem-webrat - Ruby Acceptance Testing for Web applications</code></pre>
<p>And finally lets install cucumber-nagios from our shiny new package.</p>
<pre><code>apt-get install rubygem-cucumber-nagios</code></pre>
<p>If everything has worked out you should be able to run the cucumber-nagios-gen command to create a new project. Note that the path may be different, and in the case of debian based distros the gem bin path is not on the Path.</p>
<pre><code>/usr/lib/ruby/gems/1.8/bin/cucumber-nagios-gen project test
Generating with project generator:
     [ADDED]  .gitignore
     [ADDED]  .bzrignore
     [ADDED]  Gemfile
     [ADDED]  README
     [ADDED]  features/steps
     [ADDED]  features/support</code></pre></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/04/17/Devops-weekly-archive/">Devops Weekly Archive</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-04-17T00:00:00+01:00" pubdate data-updated="true">Apr 17<span>th</span>, 2011</time>
        
         | <a href="/2011/04/17/Devops-weekly-archive/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since I launched it back in November my <a href="http://devopsweekly.com">Devops Weekly</a> email has been pretty well received I think. Folks on twitter seem to like it, as do a few people I&#8217;ve met at recent events who have said nice things. One thing a few people have been after though is an online archive, either because email just doesn&#8217;t work for them or more often because they missed out on the earlier issues.</p>
<p>With a little time this weekend and the help of <a href="https://github.com/mojombo/jekyll">Jekyll</a> I&#8217;ve just added the seventeen iss§ues to date to the new <a href="http://devopsweekly.com/archive">Devops Weekly archive</a>. I&#8217;d have liked to do something a bit more useful, maybe introduce per link tags or a nifty search feature, but I&#8217;m pretty busy at present and reason this should serve the main purpose of getting these links online.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/04/02/Vagrant-at-the-guardian/">Vagrant at the Guardian</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-04-02T00:00:00+01:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2011</time>
        
         | <a href="/2011/04/02/Vagrant-at-the-guardian/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As recent blog posts on here make clear, I&#8217;m a big fan of <a href="http://vagrantup.com">Vagrant</a>. And when <a href="http://www.brunton-spall.co.uk/">Michael</a> asked if I&#8217;d fancy talking to some of his colleagues at The Guardian about how I use it I really couldn&#8217;t say no.</p>
<p>I gave a short talk, running through the following slides, and running a few demos showing creating, destroying and provisioning new machines.</p>
<p><object id="__sse7492432" width="595" height="497"> <param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=vagrant-110402104037-phpapp01&rel=0&stripped_title=vagrant-and-configuration-management&userName=garethr" /> <param name="allowFullScreen" value="true"/> <param name="allowScriptAccess" value="always"/> <embed name="__sse7492432" src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=vagrant-110402104037-phpapp01&rel=0&stripped_title=vagrant-and-configuration-management&userName=garethr" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="595" height="497"></embed> </object></p>
<p>More interesting I thought were the questions and conversations that followed. We talked a little about how Vagrant might fit into a continuous integration setup. Another aspect some of the systems folk took to was how flexible the network configuration was and whether they might be able to use this to more effectively test firewall configurations well before the final push into a production environment. It&#8217;s not something I&#8217;ve been doing but it sounds feasable and useful in some organisations. If anyone is doing interesting things with Vagrants network config I&#8217;d be interested to know.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/04/02/Collecting-metrics-with-ganglia-and-friends/">Collecting Metrics With Ganglia and Friends</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-04-02T00:00:00+01:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2011</time>
        
         | <a href="/2011/04/02/Collecting-metrics-with-ganglia-and-friends/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I had the pleasure of speaking at <a href="http://cambridgegeeknights.net/">Cambridge Geek Night</a> on Monday again, the topic of conversation being using Ganglia to collect more than just base systems metrics.</p>
<p><object id="__sse7492405" width="595" height="497"> <param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=metricswithganglia-110402103441-phpapp01&rel=0&stripped_title=metrics-with-ganglia&userName=garethr" /> <param name="allowFullScreen" value="true"/> <param name="allowScriptAccess" value="always"/> <embed name="__sse7492405" src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=metricswithganglia-110402103441-phpapp01&rel=0&stripped_title=metrics-with-ganglia&userName=garethr" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="595" height="497"></embed> </object></p>
<p>The audience of web developers, the odd sysadmin and business folk seemed to enjoy it and we had lots of time for questions at the end. The main point I tried to get across was that Ganglia makes a great platform for ad-hoc metrics gathering due to the ability to just throw values at it and get time series graphs without any extra configuration.</p>
<p>The slides include a few bits of code I&#8217;ve been using that I&#8217;ll throw onto GitHub as a proper project when I get the time. These are very simple Python servers, one which allows for sending metrics information over <span class="caps">HTTP</span>, the other using <span class="caps">TCP</span> instead. Both really handy for getting more people to add hooks into applications.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/03/26/Devops-isnt-a-methodology/">Devops Isn&#8217;t a Methodology</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-03-26T00:00:00+00:00" pubdate data-updated="true">Mar 26<span>th</span>, 2011</time>
        
         | <a href="/2011/03/26/Devops-isnt-a-methodology/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was reading <a href="http://teddziuba.com/2011/03/devops-scam.html">Devops is a poorly executed scam</a> and just couldn&#8217;t resist a reply. Not because of the entertaining title, but because I both agree and disagree quite strongly with parts of the post. Read it first if you haven&#8217;t already. And yes I know I&#8217;m feeding the internet.</p>
<p>I&#8217;m going to pick parts of the post out and then comment. Hopefully I&#8217;m not quoting these in any way out of context.</p>
<h2>&#8220;It&#8217;s got the potential to make a handful of people a lot of money in the same way that Agile did, but nobody is really executing on.&#8221;</h2>
<p>People are pretty aware of this fact I think, but watch what happens when people post on the mailing lists or turn up at community events with a purely marketing hat on. They just get no traction and even damage their product brand amongst the early adopters. The fact the term is starting to get used in job adverts and marketing materials isn&#8217;t really being driven by the people talking about what devops might or might not be. I think the main reason for this is that most of the people I talk to in person or online are actually pretty happy with their jobs and generally work inside companies rather than as independent consultants. They have often reached an age where they want to improve within a given field but would like a wider network than their current colleagues to discuss things with.</p>
<h2>&#8220;How do you implement Devops?&#8221;</h2>
<p>I don&#8217;t think you do. The comparisons with Agile are interesting from a community point of view but Scrum is a methodology. To me at least devops isn&#8217;t, it&#8217;s just a banner or tag under which interesting conversations are happening. The argument that &#8220;You should be doing this anyway. Not earth shattering.&#8221; is a good thing. You&#8217;d be suprised by how many people don&#8217;t do all the things they should be doing, especially in small and young companies. And one of the reasons for that is no one bothered writing a list of these things down anywhere and then discussing them. I&#8217;m not saying this huge list exists or even whether it should, but the discussion is happening.</p>
<h2>&#8220;The underlying problem, however, is that dev and ops have different goals&#8221;</h2>
<p>This is spot on. I think this maybe does get missed in talk that focuses more on tools but not in the wider discussion happening about business improvements. Devops quite litterally brings those two things together. You&#8217;ll always have individual goals but where you have separate operations and development teams they should have the same fundamental goals.</p>
<h2>&#8220;Developers develop in the same environment production runs in If you deploy to Linux, you develop on Linux. No more of this coding on your Macbook Pro and deploying to Ubuntu: that is why you can&#8217;t have nice things.&#8221;</h2>
<p>Yes, yes and yes again. I&#8217;m definitely from the developer side of the tracks and I&#8217;m constantly telling people this and it&#8217;s definitely something I don&#8217;t see enough people doing. What I&#8217;d love is for all the operations people to state this to their development team and most importantly to help them set that up. Just saying <em>work like me or I won&#8217;t let you near the production machines</em> is just being obstructive. Educating and helping with tooling helps build those bridges and trust. And with trust comes the access the developers want. And less stupid bugs and less deployment issues with differing package dependencies.</p>
<h2>&#8220;None of this amounts to a methodology, as the Devops people would have you believe.&#8221;</h2>
<p>Still unsure which Devops people are saying it&#8217;s a bonefide methodology. I see the word used sometimes but generally in passing and not I don&#8217;t think meant how you mean here. And I don&#8217;t think I&#8217;ve heard people speak about it in person. &#8220;Scrum methodology&#8221; returns more than 113,000 results in Google. &#8220;Devops methodology&#8221; returns about 150, some of which 404 and half of which are agregators pointing at the other half.</p>
<h2>&#8220;The Devops movement smells of a scam in the making&#8221;</h2>
<p>Some company or other is definitely going to be scammed into paying over the odds for a consultant because they used the word Devops in the sales pitch. That will have next to nothing to do with what I&#8217;d see as the Devops movement and everything to do with human nature (and sales people).</p></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/5/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/page/3/">Newer &rarr;</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo">
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'morethanseven';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
