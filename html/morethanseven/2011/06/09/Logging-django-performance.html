<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <title>Logging Django Performance</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
    <meta content='django, performance' name='keywords' />
    <meta content='etkmKMftqAyYJM6-DP_TTKJjV0EHM5vbVcaOloSo8Z8' name='google-site-verification' />
    <link href='/assets/css/reset.css' rel='stylesheet' type='text/css' />
    <link href='/assets/css/style.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/css/code.css' rel='stylesheet' type='text/css' />
    <link href='http://www.myopenid.com/server' rel='openid.server' />
    <link href='http://garethr.myopenid.com/' rel='openid.delegate' />
    <link href='/articles.atom' rel='alternate' title='Morethanseven Atom Feed' type='application/atom+xml' />
  </head>
  <body>
    <div id='main'>
      <div id='header'>
        <div class='logo'>
          <a href='/'>&laquo; morethanseven</a>
        </div>
        <div id='carbonads-container'>
          <div class='carbonad'>
            <div id='carbon'></div>
            <script type='text/javascript'>
              //<![CDATA[
                var z = document.createElement("script");
                z.type = "text/javascript";
                z.async = true;
                z.src = "http://engine.carbonads.com/z/12119/carbon_2_1_0_HORIZ";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(z, s);
              //]]>
            </script>
          </div>
        </div>
        <div id='nav'>
          <ul>
            <li><a href='/about.html'>about</a></li>
            <li><a href='/archives.html'>archives</a></li>
            <li><a href='/tags.html'>tags</a></li>
            <li>
              <a href='/articles.atom'>rss</a>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='article'>
        <h1>
          Logging Django Performance
        </h1>
        <div class='meta'>
          <ul class='tags'>
            <li>Jun 09, 2011</li>
            <li>
              &middot;
            </li>
            <li>
              <a href='/2011/06/09/Logging-django-performance.html#disqus_thread'></a>
            </li>
            <li>&middot;</li>
            <li>
              <a class='tag' href='/tags/django/'>
                django
              </a>
            </li>
            <li>
              <a class='tag' href='/tags/performance/'>
                performance
              </a>
            </li>
          </ul>
        </div>
        <div class='body'>
          <p>I&#8217;ve been doing some basic performance profiling work with Ruby on Rails recently and one tool I found very useful was the <a href="https://github.com/wvanbergen/request-log-analyzer">request log analyzer</a>. It&#8217;s a relatively simple command line application that you can point at the Rails application log files and it outputs lots of information in agregate. So information about request duration averages or about <span class="caps">SQL</span> queries run. When working on a recent Django project I wanted a tool to do the same thing and ended up writing timelog.</p>
          <p>I did a bit of research to see if I could find something similar. Here are a few other interesting tools that didn&#8217;t quite do what I wanted:</p>
          <ul>
          	<li><a href="https://github.com/jmoiron/django-slow-log">Django Slow Log</a> &#8211; This logs things like memory and load averages</li>
          	<li><a href="https://github.com/lamby/django-dumpslow">Django Dump Slow</a> &#8211; Similar but designed to just log slow requests rather than everything, also needs a Redis backend</li>
          	<li><a href="https://github.com/jbalogh/zamboni/blob/master/apps/amo/middleware.py#L162">Zamboni Middleware</a> &#8211; This is very similar to what I wanted, but it&#8217;s not a separate module and I didn&#8217;t find anything to analyse the results</li>
          </ul>
          <p>Timelog is very similar to the middleware in Zamboni, the only real difference being I&#8217;m using the new logging support in Django 1.3. More interesting is the bundled management command which will output something like:</p>
          <pre>&#x000A;+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+&#x000A;| view                     | method | status | count | minimum | maximum | mean  | stdev           |&#x000A;+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+&#x000A;| boxes.viewsBoxDetailView | GET    | 200    | 9430  | 0.14    | 0.28    | 0.21  | 0.0700037118541 |&#x000A;+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+&#x000A;| boxes.viewsBoxListView   | GET    | 200    | 66010 | 0.17    | 0.28    | 0.232 | 0.0455415351076 |&#x000A;+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+&#x000A;| django.views.staticserve | GET    | 200    | 61295 | 0.00    | 0.02    | 0.007 | 0.0060574669888 |&#x000A;+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+</pre>
          <p>At the moment I&#8217;ve not done any real benchmarking or optimisation of the script, but it will chew through a 300,000 line (20MB) log file in under 20s on my aging macbook.</p>
          <p>The code for Timelog is on github at <a href="http://github.com/garethr/django-timelog">github.com/garethr/django-timelog</a> and I&#8217;ve uploaded to PyPi as well at <a href="http://pypi.python.org/pypi/django-timelog">pypi.com/django-timelog</a>. You can install it with the usual tools like pip:</p>
          <pre>pip install django-timelog</pre>
          <p>Once installed you need to do a little configuration to get things working. First add the middleware to your MIDDLEWARE_CLASSES in your settings file.</p>
          <pre>&#x000A;MIDDLEWARE_CLASSES = (&#x000A;  'timelog.middleware.TimeLogMiddleware',</pre>
          <p>Next add timelog to your INSTALLED_APPS list. This is purely for the management command discovery.</p>
          <pre>&#x000A;INSTALLED_APPS = (&#x000A;  'timelog',</pre>
          <p>Then configure the logger you want to use. This really depends on what you want to do, the django 1.3 logging setup is pretty powerful. Here&#8217;s how I&#8217;ve got logging setup as an example:</p>
          <pre>&#x000A;TIMELOG_LOG = '/path/to/logs/timelog.log'&#x000A;&#x000A;LOGGING = {&#x000A;  'version': 1,&#x000A;  'formatters': {&#x000A;    'plain': {&#x000A;      'format': '%(asctime)s %(message)s'},&#x000A;    },&#x000A;  'handlers': {&#x000A;    'timelog': {&#x000A;      'level': 'DEBUG',&#x000A;      'class': 'logging.handlers.RotatingFileHandler',&#x000A;      'filename': TIMELOG_LOG,&#x000A;      'maxBytes': 1024 * 1024 * 5,  # 5 MB&#x000A;      'backupCount': 5,&#x000A;      'formatter': 'plain',&#x000A;    },&#x000A;  },&#x000A;  'loggers': {&#x000A;    'timelog.middleware': {&#x000A;      'handlers': ['timelog'],&#x000A;      'level': 'DEBUG',&#x000A;      'propogate': False,&#x000A;     }&#x000A;  }&#x000A;}</pre>
          <p>In order for the analyser script to work correctly you&#8217;ll need to use the plain formatter and to register a handler for the timelog.middleware logger.</p>
          <p>With that all configured try hitting your application a few times. You should see a log file created at the location specified in TIMELOG_LOG. Fill that up with a few lines and then run the analyze_timelog management command:</p>
          <pre>python manage.py analyze_timelog</pre>
          <p>This should output something similar to the above table but with your timings and views. The management command currently allows you to point the analyzer at a different file say from a backup, or a file you&#8217;ve pulled down from production but want to run the command locally. I&#8217;ll likely add some filters as time permits for things like not showing all views or showing only views between a given date range.</p>
          <p>The above table showing the view function is good for big picture trends, but if you want to dig down into a particular path then you can pass an argument to not reverse the path:</p>
          <pre>python manage.py analyze_timelog --noreverse</pre>
          <p>This should give you something more like:</p>
          <pre>&#x000A;+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+&#x000A;| view                             | method | status | count | minimum | maximum | mean  | stdev            |&#x000A;+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+&#x000A;| /assets/css/main.css             | GET    | 200    | 61295 | 0.00    | 0.02    | 0.007 | 0.0060574669888  |&#x000A;+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+&#x000A;| / bob                            | GET    | 404    | 4715  | 0.01    | 0.01    | 0.01  | 0.0              |&#x000A;+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+&#x000A;| /                                | GET    | 200    | 66010 | 0.17    | 0.28    | 0.232 | 0.0455415351076  |&#x000A;+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+&#x000A;| /__debug__/m/css/toolbar.min.css | GET    | 304    | 4715  | 0.00    | 0.00    | 0.0   | 0.0              |&#x000A;+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+&#x000A;| /14/                             | GET    | 200    | 9430  | 0.14    | 0.28    | 0.21  | 0.0700037118541  |&#x000A;+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+</pre>
        </div>
      </div>
      <div id='other-articles'>
        <div class='older'>
          <ul>
            <li>
              <h3>
                <a href='/2011/06/04/Getting-http-headers-right.html' title=''>
                  &laquo; Debugging HTTP Headers with RedBot
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/05/15/Python-on-cloudfoundry.html' title=''>
                  &laquo; Python On Cloudfoundry
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/05/08/Vagrant-plugin-for-interacting-with-vagrantboxes.html' title=''>
                  &laquo; Vagrant Plugin For Interacting With Vagrantbox.es
                </a>
              </h3>
            </li>
          </ul>
        </div>
        <div class='newer'>
          <ul>
            <li>
              <h3>
                <a href='/2011/06/26/New-ganglia-web-interface-improvements.html' title=''>
                  New Ganglia Web Interface Improvements &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/06/30/Django-performance-1-measuring-performance.html' title=''>
                  Django Performance Patterns 1: Measuring Performance &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/07/07/Varnish-at-refresh-cambridge.html' title=''>
                  Varnish At Refresh Cambridge &raquo;
                </a>
              </h3>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='comments'>
        <div id='disqus_thread'></div>
        <script src='http://disqus.com/forums/morethanseven/embed.js' type='text/javascript'></script>
        <noscript>
          <a href='http://disqus.com/forums/morethanseven/?url=ref'>
            View the discussion thread
          </a>
        </noscript>
      </div>
      <!-- / disqus adds too much visual crap -->
      <style type='text/css'>
        .dsq-dc-logo {
          display: none !important; }
      </style>
      <div class='clear'></div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        (function() {
          var links = document.getElementsByTagName('a');
          var query = '?';
          for(var i = 0; i < links.length; i++) {
            if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
            }
          }
          document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/morethanseven/get_num_replies.js' + query + '"></' + 'script>');
        })();
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        try {
          var pageTracker = _gat._getTracker("UA-435455-1");
          pageTracker._setDomainName(".morethanseven.net");
          pageTracker._setAllowHash(false);
          pageTracker._trackPageview();
          pageTracker._trackPageLoadTime();
        } catch(err) {}
      //]]>
    </script>
  </body>
</html>
