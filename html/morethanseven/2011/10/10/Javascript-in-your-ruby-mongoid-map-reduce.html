<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <title>Javascript In Your Ruby: Mongoid Map Reduce</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
    <meta content='mongodb, javascript, mongoid, ruby' name='keywords' />
    <meta content='etkmKMftqAyYJM6-DP_TTKJjV0EHM5vbVcaOloSo8Z8' name='google-site-verification' />
    <link href='/assets/css/reset.css' rel='stylesheet' type='text/css' />
    <link href='/assets/css/style.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/css/code.css' rel='stylesheet' type='text/css' />
    <link href='http://www.myopenid.com/server' rel='openid.server' />
    <link href='http://garethr.myopenid.com/' rel='openid.delegate' />
    <link href='/articles.atom' rel='alternate' title='Morethanseven Atom Feed' type='application/atom+xml' />
  </head>
  <body>
    <div id='main'>
      <div id='header'>
        <div class='logo'>
          <a href='/'>&laquo; morethanseven</a>
        </div>
        <div id='carbonads-container'>
          <div class='carbonad'>
            <div id='carbon'></div>
            <script type='text/javascript'>
              //<![CDATA[
                var z = document.createElement("script");
                z.type = "text/javascript";
                z.async = true;
                z.src = "http://engine.carbonads.com/z/12119/carbon_2_1_0_HORIZ";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(z, s);
              //]]>
            </script>
          </div>
        </div>
        <div id='nav'>
          <ul>
            <li><a href='/about.html'>about</a></li>
            <li><a href='/archives.html'>archives</a></li>
            <li><a href='/tags.html'>tags</a></li>
            <li>
              <a href='/articles.atom'>rss</a>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='article'>
        <h1>
          Javascript In Your Ruby: Mongoid Map Reduce
        </h1>
        <div class='meta'>
          <ul class='tags'>
            <li>Oct 10, 2011</li>
            <li>
              &middot;
            </li>
            <li>
              <a href='/2011/10/10/Javascript-in-your-ruby-mongoid-map-reduce.html#disqus_thread'></a>
            </li>
            <li>&middot;</li>
            <li>
              <a class='tag' href='/tags/javascript/'>
                javascript
              </a>
            </li>
            <li>
              <a class='tag' href='/tags/mongodb/'>
                mongodb
              </a>
            </li>
            <li>
              <a class='tag' href='/tags/mongoid/'>
                mongoid
              </a>
            </li>
            <li>
              <a class='tag' href='/tags/ruby/'>
                ruby
              </a>
            </li>
          </ul>
        </div>
        <div class='body'>
          <p>We&#8217;re pretty fond of <a href="http://mongodb.org/">Mongodb</a> at work and I&#8217;ve been getting an opportunity to kick some of the more interesting tyres recently. I thought I&#8217;d document something I found myself doing here, half hoping it might be useful for anyone else with a similar problem and also to see if anyone else has a much neater approach. The examples are obviously pretty trivial, but hopefully you get the idea.</p>
          <p>So, we&#8217;re making using of the rather nice <a href="http://mongoid.org/">Mongoid</a> Ruby library for defining our models as Ruby classes. Here&#8217;s a couple of very simple classes. Anyone familiar with DataMapper or Django&#8217;s <span class="caps">ORM</span> should be right at home here.</p>
          <pre>class Publication&#x000A;  include Mongoid::Document&#x000A;&#x000A;  field :name,            :type =&gt; String&#x000A;  field :section,         :type =&gt; String&#x000A;  field :body,            :type =&gt; String&#x000A;  field :is_published,    :type =&gt; Boolean&#x000A;end&#x000A;&#x000A;class LongerPublication &lt; Publication&#x000A;  field :extra_body,      :type =&gt; String&#x000A;end</pre>
          <p>So we now have a good few publications and longer publications in our system. And folks have been creating sections with wild amandon. What I&#8217;d like to do now is do some reporting, specifically I want to know the numbers of Publications by type and publication status. And lets allow a breakdown by section while we&#8217;re at it.</p>
          <p>One approach to this is using Mongo&#8217;s built in map-reduce capability. Mongoid exposes this pretty cleanly in my view, by allowing you to write the required javascript functions (a mapper and a reducer) inline in the Ruby code. This might feel evil, but seems the best of the available options. I can see for much larger functions that splitting this out into separate javascript files for ease of testing might be nice, but were you can just test the input/output of the whole job this works for me.</p>
          <pre>KLASS = "this._type"&#x000A;SECTION = "this.section"&#x000A;&#x000A;def self.count_by(type)&#x000A;  map = &lt;&lt;EOF&#x000A;    function() {&#x000A;      function truthy(value) {&#x000A;        return (value == true) ? 1 : 0;&#x000A;      }&#x000A;      emit(#{type}, {type: #{type}, count: 1, published: truthy(this.is_published)})&#x000A;    }&#x000A;EOF&#x000A;&#x000A;  reduce = &lt;&lt;EOF&#x000A;    function(key, values) {&#x000A;      var count = 0; published = 0;&#x000A;      values.forEach(function(doc) {&#x000A;        count += parseInt(doc.count);&#x000A;        published += parseInt(doc.published);&#x000A;        type = doc.type&#x000A;      );&#x000A;      return {type: type, count: count, published: published}&#x000A;    }&#x000A;EOF&#x000A;&#x000A;  collection.mapreduce(map, reduce).find()&#x000A;&#x000A;end</pre>
          <p>In our case that will return something like the following, or rather more specifically it will return a Mongo::Cursor that allows you to get at the following data.</p>
          <pre>[{"_id"=&gt;"Publication", "value"=&gt;{"type"=&gt;"Publication", "count"=&gt;42.0, "published"=&gt;29.0}},&#x000A;{"_id"=&gt;"LongerPublication", "value"=&gt;{"type"=&gt;"LongerPublication", "count"=&gt;12.0, "published"=&gt;10.0}}]</pre>
          <p>I&#8217;ve been pretty impressed with both Mongo and Mongoid here. I like the feel of mapreduce jobs for this sort of reporting task. In particular it&#8217;s suprising how writing two languages mixed together like this doesn&#8217;t really affect the readability of the code in my view. Given that with a relational database you&#8217;d probably be writing <span class="caps">SQL</span> anyway maybe that&#8217;s not that suprising &#8211; the syntactic differences between Javascript and Ruby are much smaller than pretty much anything and <span class="caps">SQL</span>. Lots of folks have written about the increase of polyglot programming, but I wonder if we&#8217;ll see an increase in the embedding of one language in another?</p>
        </div>
      </div>
      <div id='other-articles'>
        <div class='older'>
          <ul>
            <li>
              <h3>
                <a href='/2011/09/11/Rundeck-and-nagios-nrpe-checks.html' title=''>
                  &laquo; Rundeck And Nagios Nrpe Checks
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/08/19/On-her-majestys-digital-service.html' title=''>
                  &laquo; On Her Majesty's Digital Service
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/08/11/Talking-configuration-management-vagrant-and-chef-at-lrug.html' title=''>
                  &laquo; Talking Configuration Management, Vagrant And Chef At Lrug
                </a>
              </h3>
            </li>
          </ul>
        </div>
        <div class='newer'>
          <ul>
            <li>
              <h3>
                <a href='/2011/11/02/Exposing-puppet-and-facter-information-on-the-web.html' title=''>
                  Exposing Puppet And Facter Information On The Web &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/11/16/Jenkins-parameterized-builds.html' title=''>
                  Jenkins Parameterized Builds &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/12/13/Setting-puppet-class-using-environment-variables.html' title=''>
                  Setting Puppet Class Using Environment Variables &raquo;
                </a>
              </h3>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='comments'>
        <div id='disqus_thread'></div>
        <script src='http://disqus.com/forums/morethanseven/embed.js' type='text/javascript'></script>
        <noscript>
          <a href='http://disqus.com/forums/morethanseven/?url=ref'>
            View the discussion thread
          </a>
        </noscript>
      </div>
      <!-- / disqus adds too much visual crap -->
      <style type='text/css'>
        .dsq-dc-logo {
          display: none !important; }
      </style>
      <div class='clear'></div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        (function() {
          var links = document.getElementsByTagName('a');
          var query = '?';
          for(var i = 0; i < links.length; i++) {
            if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
            }
          }
          document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/morethanseven/get_num_replies.js' + query + '"></' + 'script>');
        })();
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        try {
          var pageTracker = _gat._getTracker("UA-435455-1");
          pageTracker._setDomainName(".morethanseven.net");
          pageTracker._setAllowHash(false);
          pageTracker._trackPageview();
          pageTracker._trackPageLoadTime();
        } catch(err) {}
      //]]>
    </script>
  </body>
</html>
