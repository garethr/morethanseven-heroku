<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <title>Setting Puppet Class Using Environment Variables</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
    <meta content='puppet' name='keywords' />
    <meta content='etkmKMftqAyYJM6-DP_TTKJjV0EHM5vbVcaOloSo8Z8' name='google-site-verification' />
    <link href='/assets/css/reset.css' rel='stylesheet' type='text/css' />
    <link href='/assets/css/style.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/css/code.css' rel='stylesheet' type='text/css' />
    <link href='http://www.myopenid.com/server' rel='openid.server' />
    <link href='http://garethr.myopenid.com/' rel='openid.delegate' />
    <link href='/articles.atom' rel='alternate' title='Morethanseven Atom Feed' type='application/atom+xml' />
  </head>
  <body>
    <div id='main'>
      <div id='header'>
        <div class='logo'>
          <a href='/'>&laquo; morethanseven</a>
        </div>
        <div id='carbonads-container'>
          <div class='carbonad'>
            <div id='carbon'></div>
            <script type='text/javascript'>
              //<![CDATA[
                var z = document.createElement("script");
                z.type = "text/javascript";
                z.async = true;
                z.src = "http://engine.carbonads.com/z/12119/carbon_2_1_0_HORIZ";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(z, s);
              //]]>
            </script>
          </div>
        </div>
        <div id='nav'>
          <ul>
            <li><a href='/about.html'>about</a></li>
            <li><a href='/archives.html'>archives</a></li>
            <li><a href='/tags.html'>tags</a></li>
            <li>
              <a href='/articles.atom'>rss</a>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='article'>
        <h1>
          Setting Puppet Class Using Environment Variables
        </h1>
        <div class='meta'>
          <ul class='tags'>
            <li>Dec 13, 2011</li>
            <li>
              &middot;
            </li>
            <li>
              <a href='/2011/12/13/Setting-puppet-class-using-environment-variables.html#disqus_thread'></a>
            </li>
            <li>&middot;</li>
            <li>
              <a class='tag' href='/tags/puppet/'>
                puppet
              </a>
            </li>
          </ul>
        </div>
        <div class='body'>
          <p>I&#8217;m not sure how novel this approach is but a few folks at work hadn&#8217;t seen it before so I thought it worth jotting down.</p>
          <p>If you have even a small but dynamic set of servers then a problem arises with how those nodes are defined in puppet. A node remember is defined in puppet like so:</p>
          <pre>node web3.example.com {&#x000A;  include web_server&#x000A;}</pre>
          <p>The problem is twofold. If you have a growing infrastructure, that list of nodes is going to get quickly out of hand. The other problem is around provisioning new hosts, the obvious approach to which is something like:</p>
          <p>1. Summon new EC2 instance<br />
          2. Change the node definition to include the new hostname<br />
          3. Install puppet on instance and so the ssl certificate signing dance<br />
          4. Run puppet</p>
          <p>Step 2 stands out. The others are easily automated, but do you want to automate a change to your puppet manifests and a redeploy to the puppetmaster for a new instance? Probably not.<br />
          Puppet has the concept of an external node classifier which can be used to solve this problem, but another simpler approach is to use an environment variable on the new machine.</p>
          <p>Lets say we define our nodes something like this instead:</p>
          <pre>node default {&#x000A;  case $machine_role {&#x000A;    frontend:           { include web_server }&#x000A;    backend:            { include app_server }&#x000A;    data:               { include db_server }&#x000A;    monitoring:         { include monitoring_server }&#x000A;    development:        { include development }&#x000A;    default:            { include base }&#x000A;  }&#x000A;}</pre>
          <p>If a machine runs and sets the $machine_role variable to frontend it includes the web_server class, if that variable equals &#8216;data&#8217; it&#8217;s going to include the db_server class instead. Much cleaner and more maintainable in my view. Now to set that variable.</p>
          <p>Facter is the tool used by Puppet to get system information like the operating system or processor count. You can use these facter provided variables anywhere in your manifests. And one way of adding a new fact is via an environment variable on the client. Any environment variable prefixed with FACTER_ will be available in Puppet manifests. So in this case we can:</p>
          <pre>export FACTER_machine_role=frontend</pre>
          <p>So our steps from above become something like:</p>
          <p>1. Summon new machine<br />
          2. echo &#8220;export FACTER_machine_role=backend&#8221; &gt;&gt; /etc/environment<br />
          3. Install puppet on instance and so the ssl certificate signing dance<br />
          4. Run puppet</p>
          <p>Much easier to automate. And if you&#8217;re looking at a box and want to know what it&#8217;s role is you can check the relevant environment variable.</p>
        </div>
      </div>
      <div id='other-articles'>
        <div class='older'>
          <ul>
            <li>
              <h3>
                <a href='/2011/11/16/Jenkins-parameterized-builds.html' title=''>
                  &laquo; Jenkins Parameterized Builds
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/11/02/Exposing-puppet-and-facter-information-on-the-web.html' title=''>
                  &laquo; Exposing Puppet And Facter Information On The Web
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/10/10/Javascript-in-your-ruby-mongoid-map-reduce.html' title=''>
                  &laquo; Javascript In Your Ruby: Mongoid Map Reduce
                </a>
              </h3>
            </li>
          </ul>
        </div>
        <div class='newer'>
          <ul>
            <li>
              <h3>
                <a href='/2011/12/26/First-experience-building-something-with-clojure.html' title=''>
                  First Experience Building Something With Clojure &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/12/31/Ec2-tasks-for-fabric.html' title=''>
                  EC2 Tasks For Fabric &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2012/01/06/Talking-to-jenkins-from-campfire-with-hubot.html' title=''>
                  Talking To Jenkins From Campfire With Hubot &raquo;
                </a>
              </h3>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='comments'>
        <div id='disqus_thread'></div>
        <script src='http://disqus.com/forums/morethanseven/embed.js' type='text/javascript'></script>
        <noscript>
          <a href='http://disqus.com/forums/morethanseven/?url=ref'>
            View the discussion thread
          </a>
        </noscript>
      </div>
      <!-- / disqus adds too much visual crap -->
      <style type='text/css'>
        .dsq-dc-logo {
          display: none !important; }
      </style>
      <div class='clear'></div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        (function() {
          var links = document.getElementsByTagName('a');
          var query = '?';
          for(var i = 0; i < links.length; i++) {
            if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
            }
          }
          document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/morethanseven/get_num_replies.js' + query + '"></' + 'script>');
        })();
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        try {
          var pageTracker = _gat._getTracker("UA-435455-1");
          pageTracker._setDomainName(".morethanseven.net");
          pageTracker._setAllowHash(false);
          pageTracker._trackPageview();
          pageTracker._trackPageLoadTime();
        } catch(err) {}
      //]]>
    </script>
  </body>
</html>
