<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <title>Using Checkinstall With Virtualenv For Python Deployments</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
    <meta content='python, packaging, checkinstall' name='keywords' />
    <meta content='etkmKMftqAyYJM6-DP_TTKJjV0EHM5vbVcaOloSo8Z8' name='google-site-verification' />
    <link href='/assets/css/reset.css' rel='stylesheet' type='text/css' />
    <link href='/assets/css/style.css' media='screen' rel='stylesheet' type='text/css' />
    <link href='/assets/css/code.css' rel='stylesheet' type='text/css' />
    <link href='http://www.myopenid.com/server' rel='openid.server' />
    <link href='http://garethr.myopenid.com/' rel='openid.delegate' />
    <link href='/articles.atom' rel='alternate' title='Morethanseven Atom Feed' type='application/atom+xml' />
  </head>
  <body>
    <div id='main'>
      <div id='header'>
        <div class='logo'>
          <a href='/'>&laquo; morethanseven</a>
        </div>
        <div id='carbonads-container'>
          <div class='carbonad'>
            <div id='carbon'></div>
            <script type='text/javascript'>
              //<![CDATA[
                var z = document.createElement("script");
                z.type = "text/javascript";
                z.async = true;
                z.src = "http://engine.carbonads.com/z/12119/carbon_2_1_0_HORIZ";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(z, s);
              //]]>
            </script>
          </div>
        </div>
        <div id='nav'>
          <ul>
            <li><a href='/about.html'>about</a></li>
            <li><a href='/archives.html'>archives</a></li>
            <li><a href='/tags.html'>tags</a></li>
            <li>
              <a href='/articles.atom'>rss</a>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='article'>
        <h1>
          Using Checkinstall With Virtualenv For Python Deployments
        </h1>
        <div class='meta'>
          <ul class='tags'>
            <li>Jan 29, 2011</li>
            <li>
              &middot;
            </li>
            <li>
              <a href='/2011/01/29/Using-checkinstall-with-virtualenv-for-python-deployments.html#disqus_thread'></a>
            </li>
            <li>&middot;</li>
            <li>
              <a class='tag' href='/tags/checkinstall/'>
                checkinstall
              </a>
            </li>
            <li>
              <a class='tag' href='/tags/packaging/'>
                packaging
              </a>
            </li>
            <li>
              <a class='tag' href='/tags/python/'>
                python
              </a>
            </li>
          </ul>
        </div>
        <div class='body'>
          <p>Michael Brunton-Spall wrote last week about some <a href="http://www.brunton-spall.co.uk/post/2011/01/26/packaging-and-deploying-python-web-apps/">frustrations with packagings and deploying Python web applications</a>. Although his experience was with Python, the problems he describes are the same for Ruby and <span class="caps">PHP</span> and a whole host of languages. The following example uses Python, but works equally as well for anything else.</p>
          <p>Michael has three simple rules for his servers:</p>
          <ol>
          	<li>they cannot access the internet</li>
          	<li>they cannot access internal services that are for development</li>
          	<li>they cannot have compilers / utilities on them</li>
          </ol>
          <p>I won&#8217;t go into all the reasons for doing this (you can read the blog post linked to above) but these are pretty sensible security precautions.</p>
          <p>My approach to this problem would be to use your friendly system packages and using a handy tool called <a href="http://www.asic-linux.com.mx/~izto/checkinstall/">Checkinstall</a> to create a deb or rpm. I&#8217;m going to use as an example the <a href="http://wiki.secondlife.com/wiki/Eventlet">Eventlet</a> library. This is available in PyPi and one of it&#8217;s dependencies (Greenlets) provides a C extension. The same approach would work for an entire Python web application too. I&#8217;m as ever using the apt package management tool but this should work with yum as well.</p>
          <p>The first step is to build the package on a build machine. This should be a machine or virtual machine running the same operating system as your production web servers. You might build these packages manually or as part of a continuous integration system. On this machine we&#8217;ll need the compilers and development tools:</p>
          <pre>sudo apt-get install build-essential python-dev python-setuptools checkinstall&#x000A;sudo easy_install virtualenv</pre>
          <p>We&#8217;ll also create a virtualenv into which we&#8217;ll be installing our packages:</p>
          <pre>sudo virtualenv --no-site-packages /usr/local/environment&#x000A;source /usr/local/environment/bin/activate</pre>
          <p>Now, instead of just calling easy_install to install the package, we prefix it with checkinstall.</p>
          <pre>sudo checkinstall /usr/local/environment/bin/easy_install eventlet</pre>
          <p>This will prompt for various meta data about the package you want to create, including the name and version of the package. If you&#8217;re using this method in the real world you&#8217;ll want to decide on a versioning and naming scheme for your packages to avoid clashes with system provided packages. You can also set many of these options from the command line rather than having to manually fill them in each time.</p>
          <p>Once everything has been filled in successfully this should run through, installing eventlet and greenlets and eventually creating a deb or rpm package depending on what platform you&#8217;re running on. You should see something like:</p>
          <pre>Done. The new package has been installed and saved to&#x000A;&#x000A; /home/vagrant/eventlet-gareth_20110129-1_i386.deb&#x000A;&#x000A; You can remove it from your system anytime using: &#x000A;&#x000A;      dpkg -r eventlet-gareth</pre>
          <p>Now lets grab that package and take it to one of our front end web servers via a controlled deployment process. That front end web server needs the virtualenv creating but nothing else. So:</p>
          <pre>sudo apt-get install python-virtualenv&#x000A;sudo virtualenv --no-site-packages /usr/local/environment</pre>
          <p>(Now you might be thinking that installing the python-virtualenv package in this way breaks rule 1 above. And you&#8217;d be right in most cases, but I&#8217;m guessing Michael&#8217;s systems team have a local package repo for authorised packages, or alternatively you could download the package to the build machine and push it to the production environment.)</p>
          <p>Now install the package we created earlier.</p>
          <pre>sudo dpkg -i eventlet-gareth_20110129-1_i386.deb</pre>
          <p>That should throw all the required files into the virtualenv environment we created. No compilers. No calls to internal or external systems. Just move some precompiled binaries and text files to predefined places on disk.</p>
          <p>I used a PyPi package as an example. Checkinstall could have been pointed at a custom build file written especially for your own application, one that moves files and folders to where they are needed. Say something that looks like this:</p>
          <pre>#!/bin/sh&#x000A;cp /home/stage/myapplication /var/www/apps/</pre>
          <p>The running checkinstall against that (or a more complex build file using capistrano or ant or fabric) you can create a package containing your application code and install it into the specified place.</p>
        </div>
      </div>
      <div id='other-articles'>
        <div class='older'>
          <ul>
            <li>
              <h3>
                <a href='/2011/01/16/Why-developers-should-care-about-system-packages.html' title=''>
                  &laquo; Why Developers Should Care About System Packages
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/01/10/My-default-recipes-for-vagrant-virtual-machines.html' title=''>
                  &laquo; My Default Recipes For Vagrant Virtual Machines
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/01/01/Solr-libraries-and-good-api-design.html' title=''>
                  &laquo; Solr Libraries and Good API Design
                </a>
              </h3>
            </li>
          </ul>
        </div>
        <div class='newer'>
          <ul>
            <li>
              <h3>
                <a href='/2011/02/08/Configuration-management-for-development-environments.html' title=''>
                  Configuration Management For Development Environments &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/03/02/Devops-more-than-marketing-talk-by-james-turnbull.html' title=''>
                  Devops - More Than Marketing - Talk By James Turnbull &raquo;
                </a>
              </h3>
            </li>
            <li>
              <h3>
                <a href='/2011/03/12/Site-for-vagrant-base-boxes.html' title=''>
                  Site For Vagrant Base Boxes &raquo;
                </a>
              </h3>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div class='comments'>
        <div id='disqus_thread'></div>
        <script src='http://disqus.com/forums/morethanseven/embed.js' type='text/javascript'></script>
        <noscript>
          <a href='http://disqus.com/forums/morethanseven/?url=ref'>
            View the discussion thread
          </a>
        </noscript>
      </div>
      <!-- / disqus adds too much visual crap -->
      <style type='text/css'>
        .dsq-dc-logo {
          display: none !important; }
      </style>
      <div class='clear'></div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        (function() {
          var links = document.getElementsByTagName('a');
          var query = '?';
          for(var i = 0; i < links.length; i++) {
            if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
            }
          }
          document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/morethanseven/get_num_replies.js' + query + '"></' + 'script>');
        })();
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      //]]>
    </script>
    <script type='text/javascript'>
      //<![CDATA[
        try {
          var pageTracker = _gat._getTracker("UA-435455-1");
          pageTracker._setDomainName(".morethanseven.net");
          pageTracker._setAllowHash(false);
          pageTracker._trackPageview();
          pageTracker._trackPageLoadTime();
        } catch(err) {}
      //]]>
    </script>
  </body>
</html>
